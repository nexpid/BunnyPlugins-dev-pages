(function(exports,plugin,common,storage,assets,components,ui,_vendetta,metro,toasts,constants,patcher$1){"use strict";var _findByProps,_findByProps1,_findByProps2,_findByProps3,_findByProps4;const ThemeStore=metro.findByStoreName("ThemeStore");metro.findByProps("triggerHaptic");const colorModule=metro.findByProps("colors","unsafe_rawColors"),colorResolver=colorModule?.internal??colorModule?.meta,TextStyleSheet=metro.findByProps("TextStyleSheet").TextStyleSheet;((_findByProps=metro.findByProps("ActionSheet"))===null||_findByProps===void 0?void 0:_findByProps.ActionSheet)??metro.find(function(x){var _x_render;return((_x_render=x.render)===null||_x_render===void 0?void 0:_x_render.name)==="ActionSheet"}),metro.findByProps("openLazy","hideActionSheet"),metro.findByProps("ActionSheetTitleHeader","ActionSheetCloseButton","ActionSheetContentContainer"),(_findByProps1=metro.findByProps("ActionSheetRow"))===null||_findByProps1===void 0||_findByProps1.ActionSheetRow,metro.findByName("Navigator")??((_findByProps2=metro.findByProps("Navigator"))===null||_findByProps2===void 0||_findByProps2.Navigator),((_findByProps3=metro.findByProps("getRenderCloseButton"))===null||_findByProps3===void 0?void 0:_findByProps3.getRenderCloseButton)??((_findByProps4=metro.findByProps("getHeaderCloseButton"))===null||_findByProps4===void 0||_findByProps4.getHeaderCloseButton),metro.findByProps("popModal","pushModal");function resolveSemanticColor(color){let theme=arguments.length>1&&arguments[1]!==void 0?arguments[1]:ThemeStore.theme;return colorResolver.resolveSemanticColor(theme,color)}function fluxSubscribe(topic,callback){return common.FluxDispatcher.subscribe(topic,callback),function(){return common.FluxDispatcher.unsubscribe(topic,callback)}}const{Text:_Text}=components.General;function Text(param){let{variant,lineClamp,color,align,style,onPress,getChildren,children,liveUpdate}=param;const[_,forceUpdate]=common.React.useReducer(function(x){return~x},0);return common.React.useEffect(function(){if(!liveUpdate)return;const nextSecond=new Date().setMilliseconds(1e3);let interval;const timeout=setTimeout(function(){forceUpdate(),interval=setInterval(forceUpdate,1e3)},nextSecond-Date.now());return function(){clearTimeout(timeout),clearInterval(interval)}},[]),common.React.createElement(_Text,{style:[variant?TextStyleSheet[variant]:{},color?{color:resolveSemanticColor(ui.semanticColors[color])}:{},align?{textAlign:align}:{},style??{}],numberOfLines:lineClamp,onPress},getChildren?.()??children)}const{View,Pressable}=components.General;function BetterTableRowTitle(param){let{title,onPress,icon}=param;const styles=common.stylesheet.createThemedStyleSheet({androidRipple:{color:ui.semanticColors.ANDROID_RIPPLE,cornerRadius:4},icon:{width:16,height:16,marginTop:1.5,tintColor:ui.semanticColors.TEXT_MUTED}}),UseCompontent=onPress?Pressable:View;return React.createElement(UseCompontent,{android_ripple:styles.androidRipple,disabled:!1,accessibilityRole:"button",onPress,style:{marginBottom:8,gap:4,flexDirection:"row",alignItems:"center"}},icon&&React.createElement(common.ReactNative.Image,{style:styles.icon,source:icon,resizeMode:"cover"}),React.createElement(Text,{variant:"text-sm/semibold",color:"TEXT_MUTED"},title))}function BetterTableRowGroup(param){let{title,onTitlePress,icon,children,padding}=param;const styles=common.stylesheet.createThemedStyleSheet({main:{backgroundColor:ui.semanticColors.CARD_PRIMARY_BG,borderRadius:16,overflow:"hidden",flex:1}});return React.createElement(View,{style:{marginHorizontal:16,marginTop:16}},title?typeof title=="string"?React.createElement(BetterTableRowTitle,{title,onPress:onTitlePress,icon}):title:null,React.createElement(View,{style:styles.main},padding?React.createElement(View,{style:{paddingHorizontal:16,paddingVertical:16}},children):children))}metro.find(function(x){return x?.WebView&&!x.default}).WebView,metro.findByProps("SvgXml"),metro.findByProps("isJoi"),metro.findByProps("useSharedValue"),metro.findByProps("FlashList").FlashList;const zustand={create:metro.findByName("create")},RNMMKVManager=common.ReactNative.NativeModules.MMKVManager,RNFileManager=common.ReactNative.NativeModules.DCDFileManager??common.ReactNative.NativeModules.RTNFileManager;common.ReactNative.NativeModules.BundleUpdaterManager,common.ReactNative.NativeModules.DCDSoundManager;const RNFSManager=common.ReactNative.NativeModules.RNFSManager,OhFuck=function(prop){return function(){return common.React.useEffect(function(){toasts.showToast("Uh oh, something broke! Search for fckp in Debug Logs!"),console.warn(`Uh oh (fckp)!!
Missing the redesign component: ${prop}. Please bug @nexpid about this on Discord!`)},[]),null}},OhFuckFunction=function(prop){return function(){return toasts.showToast("Uh oh, something broke! Search for fckp in Debug Logs!"),console.warn(`Uh oh (fckp)!!
Missing the redesign function: ${prop}. Please bug @nexpid about this on Discord!`),null}},findThing=function(){for(var _len=arguments.length,props=new Array(_len),_key=0;_key<_len;_key++)props[_key]=arguments[_key];var _findByProps5;return(_findByProps5=metro.findByProps(...props))===null||_findByProps5===void 0?void 0:_findByProps5[props[0]]},findThingRequired=function(alt){for(var _len=arguments.length,props=new Array(_len>1?_len-1:0),_key=1;_key<_len;_key++)props[_key-1]=arguments[_key];return findThing(...props)??alt(props[0])};findThingRequired(OhFuck,"Button");const RowButton=findThingRequired(OhFuck,"RowButton");findThing("Slider"),findThingRequired(OhFuck,"FloatingActionButton"),findThingRequired(OhFuck,"TextInput"),findThingRequired(OhFuck,"Tabs"),findThingRequired(OhFuck,"SegmentedControlPages"),findThingRequired(OhFuckFunction,"useSegmentedControlState");const{FormSwitchRow,FormRow}=components.Forms;function Settings(){return storage.useProxy(vstorage),React.createElement(common.ReactNative.ScrollView,{style:{flex:1}},React.createElement(BetterTableRowGroup,{title:"Settings",icon:assets.getAssetIDByName("SettingsIcon")},React.createElement(FormSwitchRow,{label:"Remove link wrapping",subLabel:vstorage.config.redirect?"https://example.com/":"https://www.google.com/url?q=https://example.com/",leading:React.createElement(FormRow.Icon,{source:assets.getAssetIDByName("MagnifyingGlassIcon")}),onValueChange:function(){return vstorage.config.redirect=!vstorage.config.redirect},value:vstorage.config.redirect}),React.createElement(FormSwitchRow,{label:"Remove referral parameters",subLabel:`https://amazon.com/product${vstorage.config.referrals?"/":"?tag=nexpid-50"}`,leading:React.createElement(FormRow.Icon,{source:assets.getAssetIDByName("QuestsIcon")}),onValueChange:function(){return vstorage.config.referrals=!vstorage.config.referrals},value:vstorage.config.referrals})),React.createElement(common.ReactNative.View,{style:{marginHorizontal:16,marginTop:12}},React.createElement(RowButton,{label:"Visit source",onPress:function(){return common.url.openURL("https://gitlab.com/ClearURLs/Rules")}})))}const normalizeFilePath=function(path){return path.startsWith("file://")?path.slice(7):path},getOptions=function(encoding){if(typeof encoding=="string"){if(["utf8","ascii","base64"].includes(encoding))return{encoding};throw new Error(`Invalid encoding type "${String(encoding)}"`)}else return encoding||{encoding:"utf8"}},readFileGeneric=function(filepath,encoding,command){const options=getOptions(encoding);return command(normalizeFilePath(filepath)).then(function(b64){let contents;return options.encoding==="utf8"?contents=Buffer.from(b64,"base64").toString("utf8"):options.encoding==="ascii"?contents=Buffer.from(b64,"base64").toString("ascii"):options.encoding==="base64"&&(contents=b64),contents})},resolveWrite=function(filepath){let write={style:null,path:null};const constants2=RNFileManager.getConstants();if(filepath.startsWith(constants2.DocumentsDirPath))write={style:"documents",path:filepath.slice(constants2.DocumentsDirPath.length+1)};else if(filepath.startsWith(constants2.CacheDirPath))write={style:"cache",path:filepath.slice(constants2.CacheDirPath.length+1)};else throw new Error(`File path "${String(filepath)}" is unsupported on versions <211.6 (not a caches/documents path, missing RNFS)`);return write},RNFS={unlink(filepath){if(RNFSManager)return RNFSManager.unlink(normalizeFilePath(filepath)).then(function(){});const write=resolveWrite(filepath);return RNFileManager.removeFile(write.style,write.path).then(function(){})},exists(filepath){return RNFSManager?RNFSManager.exists(normalizeFilePath(filepath)):RNFileManager.fileExists(normalizeFilePath(filepath))},readFile(filepath,encoding){if(RNFSManager)return readFileGeneric(filepath,encoding,RNFSManager.readFile);{const options=getOptions(encoding);if(options.encoding==="ascii")throw new Error('Encoding type "ascii" is unsupported on versions <211.6 (missing RNFS)');return RNFileManager.readFile(filepath,options.encoding)}},writeFile(filepath,contents,encoding){const options=getOptions(encoding);if(!RNFSManager){if(options.encoding==="ascii")throw new Error('Encoding type "ascii" is unsupported on versions <211.6 (missing RNFS)');const write=resolveWrite(filepath);return RNFileManager.writeFile(write.style,write.path,contents,options.encoding).then(function(){})}let b64;return options.encoding==="utf8"?b64=Buffer.from(contents,"utf8").toString("base64"):options.encoding==="ascii"?b64=Buffer.from(contents,"ascii").toString("base64"):options.encoding==="base64"&&(b64=contents),RNFSManager.writeFile(normalizeFilePath(filepath),b64,options)},mkdir(filepath){if(!RNFSManager)throw new Error("Function 'mkdir' is unsupported on versions <211.6 (missing RNFS)");return RNFSManager.mkdir(normalizeFilePath(filepath),{}).then(function(){})},MainBundlePath:RNFSManager?.RNFSMainBundlePath,get CachesDirectoryPath(){return RNFSManager?.RNFSCachesDirectoryPath??RNFileManager.getConstants().CacheDirPath},ExternalCachesDirectoryPath:RNFSManager?.RNFSExternalCachesDirectoryPath,get DocumentDirectoryPath(){return RNFSManager?.RNFSDocumentDirectoryPath??RNFileManager.getConstants().DocumentsDirPath},DownloadDirectoryPath:RNFSManager?.RNFSDownloadDirectoryPath,ExternalDirectoryPath:RNFSManager?.RNFSExternalDirectoryPath,ExternalStorageDirectoryPath:RNFSManager?.RNFSExternalStorageDirectoryPath,TemporaryDirectoryPath:RNFSManager?.RNFSTemporaryDirectoryPath,LibraryDirectoryPath:RNFSManager?.RNFSLibraryDirectoryPath,PicturesDirectoryPath:RNFSManager?.RNFSPicturesDirectoryPath,FileProtectionKeys:RNFSManager?.RNFSFileProtectionKeys,RoamingDirectoryPath:RNFSManager?.RNFSRoamingDirectoryPath,hasRNFS:!!RNFSManager};function createJSONStorage(getStorage,options){let storage2;try{storage2=getStorage()}catch{return}return{getItem:function(name){var _a;const parse=function(str2){return str2===null?null:JSON.parse(str2,void 0)},str=(_a=storage2.getItem(name))!=null?_a:null;return str instanceof Promise?str.then(parse):parse(str)},setItem:function(name,newValue){return storage2.setItem(name,JSON.stringify(newValue,void 0))},removeItem:function(name){return storage2.removeItem(name)}}}const toThenable=function(fn){return function(input){try{const result=fn(input);return result instanceof Promise?result:{then(onFulfilled){return toThenable(onFulfilled)(result)},catch(_onRejected){return this}}}catch(e){return{then(_onFulfilled){return this},catch(onRejected){return toThenable(onRejected)(e)}}}}},oldImpl=function(config,baseOptions){return function(set,get,api){let options={getStorage:function(){return localStorage},serialize:JSON.stringify,deserialize:JSON.parse,partialize:function(state){return state},version:0,merge:function(persistedState,currentState){return{...currentState,...persistedState}},...baseOptions},hasHydrated=!1;const hydrationListeners=new Set,finishHydrationListeners=new Set;let storage2;try{storage2=options.getStorage()}catch{}if(!storage2)return config(function(){for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++)args[_key]=arguments[_key];console.warn(`[zustand persist middleware] Unable to update item '${options.name}', the given storage is currently unavailable.`),set(...args)},get,api);const thenableSerialize=toThenable(options.serialize),setItem=function(){const state=options.partialize({...get()});let errorInSync;const thenable=thenableSerialize({state,version:options.version}).then(function(serializedValue){return storage2.setItem(options.name,serializedValue)}).catch(function(e){errorInSync=e});if(errorInSync)throw errorInSync;return thenable},savedSetState=api.setState;api.setState=function(state,replace){savedSetState(state,replace),setItem()};const configResult=config(function(){for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++)args[_key]=arguments[_key];set(...args),setItem()},get,api);let stateFromStorage;const hydrate=function(){var _a;if(!storage2)return;hasHydrated=!1,hydrationListeners.forEach(function(cb){return cb(get())});const postRehydrationCallback=((_a=options.onRehydrateStorage)==null?void 0:_a.call(options,get()))||void 0;return toThenable(storage2.getItem.bind(storage2))(options.name).then(function(storageValue){if(storageValue)return options.deserialize(storageValue)}).then(function(deserializedStorageValue){if(deserializedStorageValue)if(typeof deserializedStorageValue.version=="number"&&deserializedStorageValue.version!==options.version){if(options.migrate)return options.migrate(deserializedStorageValue.state,deserializedStorageValue.version);console.error("State loaded from storage couldn't be migrated since no migrate function was provided")}else return deserializedStorageValue.state}).then(function(migratedState){var _a2;return stateFromStorage=options.merge(migratedState,(_a2=get())!=null?_a2:configResult),set(stateFromStorage,!0),setItem()}).then(function(){postRehydrationCallback?.(stateFromStorage,void 0),hasHydrated=!0,finishHydrationListeners.forEach(function(cb){return cb(stateFromStorage)})}).catch(function(e){postRehydrationCallback?.(void 0,e)})};return api.persist={setOptions:function(newOptions){options={...options,...newOptions},newOptions.getStorage&&(storage2=newOptions.getStorage())},clearStorage:function(){storage2?.removeItem(options.name)},getOptions:function(){return options},rehydrate:function(){return hydrate()},hasHydrated:function(){return hasHydrated},onHydrate:function(cb){return hydrationListeners.add(cb),function(){hydrationListeners.delete(cb)}},onFinishHydration:function(cb){return finishHydrationListeners.add(cb),function(){finishHydrationListeners.delete(cb)}}},hydrate(),stateFromStorage||configResult}},newImpl=function(config,baseOptions){return function(set,get,api){let options={storage:createJSONStorage(function(){return localStorage}),partialize:function(state){return state},version:0,merge:function(persistedState,currentState){return{...currentState,...persistedState}},...baseOptions},hasHydrated=!1;const hydrationListeners=new Set,finishHydrationListeners=new Set;let storage2=options.storage;if(!storage2)return config(function(){for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++)args[_key]=arguments[_key];console.warn(`[zustand persist middleware] Unable to update item '${options.name}', the given storage is currently unavailable.`),set(...args)},get,api);const setItem=function(){const state=options.partialize({...get()});return storage2.setItem(options.name,{state,version:options.version})},savedSetState=api.setState;api.setState=function(state,replace){savedSetState(state,replace),setItem()};const configResult=config(function(){for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++)args[_key]=arguments[_key];set(...args),setItem()},get,api);api.getInitialState=function(){return configResult};let stateFromStorage;const hydrate=function(){var _a,_b;if(!storage2)return;hasHydrated=!1,hydrationListeners.forEach(function(cb){var _a2;return cb((_a2=get())!=null?_a2:configResult)});const postRehydrationCallback=((_b=options.onRehydrateStorage)==null?void 0:_b.call(options,(_a=get())!=null?_a:configResult))||void 0;return toThenable(storage2.getItem.bind(storage2))(options.name).then(function(deserializedStorageValue){if(deserializedStorageValue)if(typeof deserializedStorageValue.version=="number"&&deserializedStorageValue.version!==options.version){if(options.migrate)return options.migrate(deserializedStorageValue.state,deserializedStorageValue.version);console.error("State loaded from storage couldn't be migrated since no migrate function was provided")}else return deserializedStorageValue.state}).then(function(migratedState){var _a2;return stateFromStorage=options.merge(migratedState,(_a2=get())!=null?_a2:configResult),set(stateFromStorage,!0),setItem()}).then(function(){postRehydrationCallback?.(stateFromStorage,void 0),stateFromStorage=get(),hasHydrated=!0,finishHydrationListeners.forEach(function(cb){return cb(stateFromStorage)})}).catch(function(e){postRehydrationCallback?.(void 0,e)})};return api.persist={setOptions:function(newOptions){options={...options,...newOptions},newOptions.storage&&(storage2=newOptions.storage)},clearStorage:function(){storage2?.removeItem(options.name)},getOptions:function(){return options},rehydrate:function(){return hydrate()},hasHydrated:function(){return hasHydrated},onHydrate:function(cb){return hydrationListeners.add(cb),function(){hydrationListeners.delete(cb)}},onFinishHydration:function(cb){return finishHydrationListeners.add(cb),function(){finishHydrationListeners.delete(cb)}}},options.skipHydration||hydrate(),stateFromStorage||configResult}},persist=function(config,baseOptions){return"getStorage"in baseOptions||"serialize"in baseOptions||"deserialize"in baseOptions?(console.warn("[DEPRECATED] `getStorage`, `serialize` and `deserialize` options are deprecated. Use `storage` option instead."),oldImpl(config,baseOptions)):newImpl(config,baseOptions)},useRulesStore=zustand.create(persist(function(set,get){return{rules:null,lastModified:null,update:async function(){const res=await fetch(listUrl,{headers:{"if-modified-since":get().lastModified}});if(!res.ok)return;const rules=await res.json();set({rules,lastModified:res.headers.get("last-modified")})}}},{name:"clean-urls-rules",storage:createJSONStorage(function(){return RNMMKVManager}),partialize:function(state){return{rules:state.rules,lastModified:state.lastModified}},onRehydrateStorage:function(){return function(state){return state.update()}}})),unsubRulesStore=fluxSubscribe("CONNECTION_OPEN",function(){return useRulesStore.getState().update()}),_depreacted_filePath=function(){return`${RNFS.DocumentDirectoryPath}/vendetta/CleanURLs/list.json`},useProvider=function(provider,urlObj){const url=urlObj.toString(),query=new Array;if(urlObj.searchParams.forEach(function(_,key){return query.push(key)}),vstorage.config.redirect&&provider.redirections){var _url_match;const redirect=provider.redirections.find(function(reg){return url.match(new RegExp(reg,"i"))}),red=redirect&&((_url_match=url.match(new RegExp(redirect,"i")))===null||_url_match===void 0?void 0:_url_match[1]);if(red)return cleanUrl(decodeURIComponent(red))}if(provider.rawRules&&query.length>0)for(const rule of provider.rawRules)urlObj.search=urlObj.search.replace(new RegExp(rule,"gi"),"");const toRemove=[].concat(provider?.rules??[],(vstorage.config.referrals&&provider?.referralMarketing)??[]);if(toRemove.length>0&&query.length>0)for(const rule of toRemove)for(const key of query)new RegExp(`^${rule}$`,"i").test(key)&&urlObj.searchParams.delete(key);return urlObj.toString()};function cleanUrl(url){const rules=useRulesStore.getState().rules;if(!rules?.providers)return url;let urlObj;try{urlObj=new URL(url)}catch{return url}for(const provider of Object.values(rules.providers)){var _provider_exceptions;if(provider.urlPattern&&new RegExp(provider.urlPattern,"i").test(url)&&!(!((_provider_exceptions=provider.exceptions)===null||_provider_exceptions===void 0)&&_provider_exceptions.some(function(reg){return new RegExp(reg,"i").test(url)})))try{urlObj=new URL(useProvider(provider,urlObj))}catch{return urlObj.toString()}}return urlObj.toString()}const Messages=metro.findByProps("sendMessage","editMessage"),DCDChatManager=common.ReactNative.NativeModules.DCDChatManager,clean=function(text){return text.replace(constants.HTTP_REGEX_MULTI,function(str){let url;try{url=new URL(str)}catch{return str}return cleanUrl(url.toString())})},handleMessage=function(msg){msg?.content&&(msg.content=clean(msg.content))},handleContent=function(content){for(const thing of content)thing.type==="link"&&thing.target&&(thing.target=clean(thing.target)),typeof thing.content=="string"?thing.content=clean(thing.content):Array.isArray(thing.content)&&(thing.content=handleContent(thing.content));return content};function patcher(){const patches=new Array;return RNFS.exists(_depreacted_filePath()).then(function(yes){return yes&&RNFS.unlink(_depreacted_filePath())}),patches.push(patcher$1.before("sendMessage",Messages,function(args){return handleMessage(args[1])})),patches.push(patcher$1.before("editMessage",Messages,function(args){return handleMessage(args[2])})),patches.push(patcher$1.before("updateRows",DCDChatManager,function(args){var _row_message;const rows=JSON.parse(args[1]);for(const row of rows)!((_row_message=row.message)===null||_row_message===void 0)&&_row_message.content&&(row.message.content=handleContent(row.message.content));args[1]=JSON.stringify(rows)})),patches.push(unsubRulesStore),function(){return patches.forEach(function(x){return x()})}}const listUrl="https://rules2.clearurls.xyz/data.minify.json",vstorage=plugin.storage;let unpatch;var index={onLoad:function(){vstorage.config??(vstorage.config={redirect:!0,referrals:!1}),unpatch=patcher()},onUnload:function(){return unpatch?.()},settings:Settings};return exports.default=index,exports.listUrl=listUrl,exports.vstorage=vstorage,Object.defineProperty(exports,"__esModule",{value:!0}),exports})({},vendetta.plugin,vendetta.metro.common,vendetta.storage,vendetta.ui.assets,vendetta.ui.components,vendetta.ui,vendetta,vendetta.metro,vendetta.ui.toasts,vendetta.constants,vendetta.patcher);
