(function(exports,_vendetta,plugin,plugins,storage,themes,metro,common,alerts,assets,components,toasts,ui,patcher$1,utils){"use strict";var constants$1={github:{url:"https://github.com/nexpid/BunnyPlugins/",raw:"https://raw.githubusercontent.com/nexpid/BunnyPlugins/main/"}};const WebView=metro.find(function(x){return x?.WebView&&!x.default}).WebView;metro.findByProps("SvgXml"),metro.findByProps("isJoi"),metro.findByProps("useSharedValue"),metro.findByProps("FlashList").FlashList;const RNFileManager=common.ReactNative.NativeModules.DCDFileManager??common.ReactNative.NativeModules.RTNFileManager,RNBundleUpdaterManager=common.ReactNative.NativeModules.BundleUpdaterManager,RNMMKVManager=common.ReactNative.NativeModules.MMKVManager,RNSoundManager=common.ReactNative.NativeModules.DCDSoundManager,RNFSManager=common.ReactNative.NativeModules.RNFSManager,normalizeFilePath=function(path){return path.startsWith("file://")?path.slice(7):path},getOptions=function(encoding){if(typeof encoding=="string"){if(["utf8","ascii","base64"].includes(encoding))return{encoding};throw new Error(`Invalid encoding type "${String(encoding)}"`)}else return encoding||{encoding:"utf8"}},readFileGeneric=function(filepath,encoding,command){const options=getOptions(encoding);return command(normalizeFilePath(filepath)).then(function(b64){let contents;return options.encoding==="utf8"?contents=Buffer.from(b64,"base64").toString("utf8"):options.encoding==="ascii"?contents=Buffer.from(b64,"base64").toString("ascii"):options.encoding==="base64"&&(contents=b64),contents})},resolveWrite=function(filepath){let write={style:null,path:null};const constants2=RNFileManager.getConstants();if(filepath.startsWith(constants2.DocumentsDirPath))write={style:"documents",path:filepath.slice(constants2.DocumentsDirPath.length+1)};else if(filepath.startsWith(constants2.CacheDirPath))write={style:"cache",path:filepath.slice(constants2.CacheDirPath.length+1)};else throw new Error(`File path "${String(filepath)}" is unsupported on versions <211.6 (not a caches/documents path, missing RNFS)`);return write},RNFS={unlink(filepath){if(RNFSManager)return RNFSManager.unlink(normalizeFilePath(filepath)).then(function(){});const write=resolveWrite(filepath);return RNFileManager.removeFile(write.style,write.path).then(function(){})},exists(filepath){return RNFSManager?RNFSManager.exists(normalizeFilePath(filepath)):RNFileManager.fileExists(normalizeFilePath(filepath))},readFile(filepath,encoding){if(RNFSManager)return readFileGeneric(filepath,encoding,RNFSManager.readFile);{const options=getOptions(encoding);if(options.encoding==="ascii")throw new Error('Encoding type "ascii" is unsupported on versions <211.6 (missing RNFS)');return RNFileManager.readFile(filepath,options.encoding)}},writeFile(filepath,contents,encoding){const options=getOptions(encoding);if(!RNFSManager){if(options.encoding==="ascii")throw new Error('Encoding type "ascii" is unsupported on versions <211.6 (missing RNFS)');const write=resolveWrite(filepath);return RNFileManager.writeFile(write.style,write.path,contents,options.encoding).then(function(){})}let b64;return options.encoding==="utf8"?b64=Buffer.from(contents,"utf8").toString("base64"):options.encoding==="ascii"?b64=Buffer.from(contents,"ascii").toString("base64"):options.encoding==="base64"&&(b64=contents),RNFSManager.writeFile(normalizeFilePath(filepath),b64,options)},mkdir(filepath){if(!RNFSManager)throw new Error("Function 'mkdir' is unsupported on versions <211.6 (missing RNFS)");return RNFSManager.mkdir(normalizeFilePath(filepath),{}).then(function(){})},MainBundlePath:RNFSManager?.RNFSMainBundlePath,get CachesDirectoryPath(){return RNFSManager?.RNFSCachesDirectoryPath??RNFileManager.getConstants().CacheDirPath},ExternalCachesDirectoryPath:RNFSManager?.RNFSExternalCachesDirectoryPath,get DocumentDirectoryPath(){return RNFSManager?.RNFSDocumentDirectoryPath??RNFileManager.getConstants().DocumentsDirPath},DownloadDirectoryPath:RNFSManager?.RNFSDownloadDirectoryPath,ExternalDirectoryPath:RNFSManager?.RNFSExternalDirectoryPath,ExternalStorageDirectoryPath:RNFSManager?.RNFSExternalStorageDirectoryPath,TemporaryDirectoryPath:RNFSManager?.RNFSTemporaryDirectoryPath,LibraryDirectoryPath:RNFSManager?.RNFSLibraryDirectoryPath,PicturesDirectoryPath:RNFSManager?.RNFSPicturesDirectoryPath,FileProtectionKeys:RNFSManager?.RNFSFileProtectionKeys,RoamingDirectoryPath:RNFSManager?.RNFSRoamingDirectoryPath,hasRNFS:!!RNFSManager},variableRules=[/{([^}]+), (select|plural), ?\n?([\s\S]+?)(?=(}})|(} ?\r?\n ?}))/g,/{([^}]+)}/g],replacerRegExp=/(\w+) {([^}]*)} ?/g;function parseVariableRules(text){const rules=[];for(const regex of variableRules){const matches=text.matchAll(regex);for(const rawMatch of Array.from(matches)){const[match,variable,kind,rawReplacers,_suffix1,_suffix2]=rawMatch,{index:index2}=rawMatch,suffix=_suffix1??_suffix2??"";if(!rules.some(function(x){return index2>=x.start&&index2<x.start+x.length}))if(!kind)rules.push({type:"variable",variable,start:index2,length:match.length+suffix.length});else{const replacers=Object.fromEntries(Array.from((rawReplacers+"}").matchAll(replacerRegExp)).map(function(x){return[x[1],x[2]]}));rules.push({type:"choose",kind,variable,start:index2,length:match.length+suffix.length,replacers})}}}return rules}var define_DEFAULT_LANG_default2={"plugin.name":"Cloud Sync",plugins:`{plugins, plural,
=0 {# plugins}
one {# plugin}
other {# plugins}
}`,themes:`{themes, plural,
=0 {# themes}
one {# theme}
other {# themes}
}`,"toast.sync.no_import":"Nothing to import.","toast.oauth.authorized":"Successfully authorized!","toast.api.unauthorized":"Unauthorized, try logging out and back in again.","toast.logout":"Successfully logged out.","toast.deleted_data":"Successfully deleted data.","toast.saved_data":"Successfully saved data.","toast.encrypt_fail":"Failed to encrypt!","toast.backup_saved":"Backup Saved to {file}.","toast.backup_download_prepare":"Preparing for download...","toast.errored":"Got an error! {error}","toast.decrypt_fail":"Failed to decrypt!","settings.current_data.title":"Current Data","settings.current_data.plugins":"plugins","settings.current_data.themes":"themes","settings.config.title":"Settings","settings.config.auto_save.title":"Auto Save","settings.config.auto_save.description":"Automatically save data to cloud","settings.config.auto_save.reinstall_warning":"You must reinstall your client in order to use Auto Save!","settings.config.settings_pin.title":"Pin To Settings","settings.config.settings_pin.description":"Pin Cloud Sync to the settings page","settings.dev.api_url.title":"API URL","settings.dev.api_url.description":"Custom URL for the Cloud Sync backend API","settings.dev.client_id.title":"Client ID","settings.dev.client_id.description":"Custom client ID for OAuth2","settings.auth.title":"Authorization","settings.auth.log_out.title":"Log out","settings.auth.log_out.description":"Logs you out of Cloud Sync","settings.auth.delete_data.title":"Delete data","settings.auth.delete_data.description":"Deletes your Cloud Sync data","settings.auth.authorize":"Authorize","settings.data.title":"Data Management","settings.data.save_data.title":"Save Data","settings.data.save_data.description":"Saves your data to the Cloud Sync API","settings.data.import_data.description":"Imports data from the Cloud Sync API","settings.data.export_local_data.title":"Export Local Data","settings.data.export_local_data.description":"Exports data to a .txt file","settings.data.import_local_data.title":"Import Local Data","settings.data.import_local_data.description":"Imports data from a .txt file","settings.label.auth_needed":"Authorize first to manage your data","sheet.import_data.title":"Import Data","sheet.import_data.already_synced":"All addons in the cloud are already imported","sheet.import_data.unproxied_plugins":"Unproxied Plugins ({count})","sheet.import_data.plugins":"Plugins ({count})","sheet.import_data.themes":"Themes ({count})","sheet.import_data.import":"Import","log.import.start.combo":"Starting to import {plugins} and {themes}","log.import.plugin.success":"Imported plugin: {name}","log.import.plugin.fail":`Failed to import plugin: {name}
{error}`,"log.import.theme.success":"Imported theme: {name}","log.import.theme.fail":`Failed to import theme: {name}
{error}`,"log.import.total":"Imported {plugins} and {themes}","log.import.select_theme":"Selecting theme: {theme}","log.plugins":"PLUGINS","log.themes":"THEMES","log.importer":"IMPORTER","alert.change_theme.title":"Theme selected","alert.change_theme.body":"A reload is required to see the selected theme. Do you want to reload now?","alert.change_theme.confirm":"Reload","alert.change_theme.cancel":"Skip","alert.log_out.title":"Log out","alert.log_out.body":"Are you sure you want to log out of Cloud Sync?","alert.delete_data.title":"Delete data","alert.delete_data.body":"Are you sure you want to delete your save data? (this cannot be undone!)","alert.delete_data.confirm":"Delete","alert.save_data.title":"Save data","alert.save_data.body":"Are you sure you want to overwrite your save data? (this cannot be undone!)","alert.save_data.confirm":"Overwrite","alert.encryption_key.title":"Enter encryption key","alert.encryption_key.placeholder":"secret password","alert.encryption_key.confirm":"Enter","alert.encryption_key.required":"An encryption key must be set.","alert.decryption_key.title":"Enter decryption key","alert.decryption_key.placeholder":"secret password","alert.decryption_key.confirm":"Enter","alert.decryption_key.required":"A decryption key must be set.","alert.unproxied_plugin_warn.title":"Warning","alert.unproxied_plugin_warn.body":"Installing unproxied plugins can be dangerous since they haven't been verified by staff. Are you sure you want to import them?","alert.unproxied_plugin_warn.confirm":"Yes","alert.plugin_settings_revert.title":"Revert Settings","alert.plugin_settings_revert.body":"Are you sure you want to revert all plugin settings?","alert.plugin_settings_revert.confirm":"Revert","page.import_logs":"Import Logs","page.plugin_settings.title":"Plugin Settings","page.plugin_settings.sync_plugin":"Sync Plugin","page.plugin_settings.sync_plugin_storage":"Sync Plugin Storage","log.import.result.success":"Finished! Imported {plugins} and {themes}. All imports were successful.","log.import.result.fail":"Finished! Imported {plugins} and {themes}. Failed to import {failed_plugins} and {failed_themes}."};function _class_call_check$1(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function _create_class(Constructor,protoProps,staticProps){return protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Constructor}function _define_property(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}const IntlMessageFormat=metro.findByName("MessageFormat"),make=function(){return RNFS.hasRNFS&&RNFS.mkdir(`${RNFS.DocumentDirectoryPath}/vendetta/NexpidLang`)},filePath=function(plugin2){return`${RNFS.DocumentDirectoryPath}/vendetta/NexpidLang/${plugin2}.json`},etagPath=function(plugin2){return`${RNFS.DocumentDirectoryPath}/vendetta/NexpidLang/${plugin2}_etag.txt`};let Lang=function(){function Lang2(plugin2){_class_call_check$1(this,Lang2),_define_property(this,"plugin",void 0),_define_property(this,"values",void 0),_define_property(this,"controller",void 0),_define_property(this,"variableRules",void 0),_define_property(this,"Values",void 0),this.plugin=plugin2,this.values=null,this.controller=new AbortController,this.variableRules={},this.load()}return _create_class(Lang2,[{key:"load",value:async function(){var _this=this;const read=async function(){if(await RNFS.exists(filePath(_this.plugin)))try{_this.values=JSON.parse(await RNFS.readFile(filePath(_this.plugin)))}catch{return}};{const res=await fetch(`${constants$1.github.raw}lang/values/${this.plugin}.json`,{headers:{"cache-control":"public, max-age=20"}});if(!res.ok)return read();make();const lastEtag=await RNFS.exists(etagPath(this.plugin))&&await RNFS.readFile(etagPath(this.plugin)),newEtag=res.headers.get("etag");if(!newEtag)return read();if(newEtag!==lastEtag){RNFS.writeFile(etagPath(this.plugin),newEtag);const txt=await res.text();RNFS.writeFile(filePath(this.plugin),txt);try{this.values=JSON.parse(txt)}catch{return}}else read()}}},{key:"makeVariableRules",value:function(text){const rules=parseVariableRules(text);return this.variableRules=rules,rules}},{key:"unload",value:function(){this.controller.abort()}},{key:"format",value:function(_key,input){var _this_values_locale,_this_values_en,_DEFAULT_LANG;const key=_key,locale=Lang2.getLang();if(!this.values)return String(key);const val=((_this_values_locale=this.values[locale])===null||_this_values_locale===void 0?void 0:_this_values_locale[key])??((_this_values_en=this.values.en)===null||_this_values_en===void 0?void 0:_this_values_en[key])??((_DEFAULT_LANG=define_DEFAULT_LANG_default2)===null||_DEFAULT_LANG===void 0?void 0:_DEFAULT_LANG[key]);return val?(this.variableRules[val]??this.makeVariableRules(val)).length>0?new IntlMessageFormat(val).format(input):val:String(key)}}],[{key:"getLang",value:function(){var _i18n_getLocale;const lang2=((_i18n_getLocale=common.i18n.getLocale())===null||_i18n_getLocale===void 0?void 0:_i18n_getLocale.replace(/-/g,"_"))??"en";return lang2.startsWith("en_")?"en":lang2}},{key:"basicFormat",value:function(text){const rules=[{regex:/\*\*(.*?)\*\*/g,react:function(txt2){return React.createElement(common.ReactNative.Text,{style:{fontWeight:"900"}},txt2)}}],txt=text.split("");let off=0;for(const rule of rules){const matches=Array.from(text.matchAll(rule.regex));for(const match of matches)match[1]&&(txt.splice(match.index-off,match[0].length,rule.react(match[1])),off+=match[0].length-1)}return txt}}]),Lang2}();var _findByProps,_findByProps1,_findByProps2,_findByProps3,_findByProps4;const ThemeStore=metro.findByStoreName("ThemeStore");metro.findByProps("triggerHaptic");const colorModule=metro.findByProps("colors","unsafe_rawColors"),colorResolver=colorModule?.internal??colorModule?.meta,TextStyleSheet=metro.findByProps("TextStyleSheet").TextStyleSheet,ActionSheet=((_findByProps=metro.findByProps("ActionSheet"))===null||_findByProps===void 0?void 0:_findByProps.ActionSheet)??metro.find(function(x){var _x_render;return((_x_render=x.render)===null||_x_render===void 0?void 0:_x_render.name)==="ActionSheet"}),LazyActionSheet=metro.findByProps("openLazy","hideActionSheet"),{openLazy,hideActionSheet}=LazyActionSheet,{ActionSheetTitleHeader,ActionSheetCloseButton,ActionSheetContentContainer}=metro.findByProps("ActionSheetTitleHeader","ActionSheetCloseButton","ActionSheetContentContainer");(_findByProps1=metro.findByProps("ActionSheetRow"))===null||_findByProps1===void 0||_findByProps1.ActionSheetRow,metro.findByName("Navigator")??((_findByProps2=metro.findByProps("Navigator"))===null||_findByProps2===void 0||_findByProps2.Navigator),((_findByProps3=metro.findByProps("getRenderCloseButton"))===null||_findByProps3===void 0?void 0:_findByProps3.getRenderCloseButton)??((_findByProps4=metro.findByProps("getHeaderCloseButton"))===null||_findByProps4===void 0||_findByProps4.getHeaderCloseButton),metro.findByProps("popModal","pushModal");function resolveSemanticColor(color){let theme=arguments.length>1&&arguments[1]!==void 0?arguments[1]:ThemeStore.theme;return colorResolver.resolveSemanticColor(theme,color)}function openSheet(sheet,props){try{openLazy(new Promise(function(x){return x({default:sheet})}),"ActionSheet",props)}catch(e){_vendetta.logger.error(e.stack),toasts.showToast("Got error when opening ActionSheet! Please check debug logs",assets.getAssetIDByName("Smal"))}}const{Text:_Text}=components.General;function Text$1(param){let{variant,lineClamp,color,align,style,onPress,getChildren,children,liveUpdate}=param;const[_,forceUpdate]=common.React.useReducer(function(x){return~x},0);return common.React.useEffect(function(){if(!liveUpdate)return;const nextSecond=new Date().setMilliseconds(1e3);let interval;const timeout=setTimeout(function(){forceUpdate(),interval=setInterval(forceUpdate,1e3)},nextSecond-Date.now());return function(){clearTimeout(timeout),clearInterval(interval)}},[]),common.React.createElement(_Text,{style:[variant?TextStyleSheet[variant]:{},color?{color:resolveSemanticColor(ui.semanticColors[color])}:{},align?{textAlign:align}:{},style??{}],numberOfLines:lineClamp,onPress},getChildren?.()??children)}const{View:View$4,Pressable}=components.General;function BetterTableRowTitle(param){let{title,onPress,icon}=param;const styles2=common.stylesheet.createThemedStyleSheet({androidRipple:{color:ui.semanticColors.ANDROID_RIPPLE},icon:{width:16,height:16,marginTop:1.5,tintColor:ui.semanticColors.TEXT_MUTED}}),UseCompontent=onPress?Pressable:View$4;return React.createElement(UseCompontent,{android_ripple:styles2.androidRipple,disabled:!1,accessibilityRole:"button",onPress,style:{marginBottom:8,gap:4,flexDirection:"row",alignItems:"center"}},icon&&React.createElement(common.ReactNative.Image,{style:styles2.icon,source:icon,resizeMode:"cover"}),React.createElement(Text$1,{variant:"text-sm/semibold",color:"TEXT_MUTED"},title))}function BetterTableRowGroup(param){let{title,onTitlePress,icon,children,padding}=param;const styles2=common.stylesheet.createThemedStyleSheet({main:{backgroundColor:ui.semanticColors.CARD_PRIMARY_BG,borderRadius:16,overflow:"hidden",flex:1}});return React.createElement(View$4,{style:{marginHorizontal:16,marginTop:16}},title&&React.createElement(BetterTableRowTitle,{title,onPress:onTitlePress,icon}),React.createElement(View$4,{style:styles2.main},padding?React.createElement(View$4,{style:{paddingHorizontal:16,paddingVertical:16}},children):children))}const{View:View$3}=components.General;function LineDivider(param){let{addPadding}=param;const styles2=common.stylesheet.createThemedStyleSheet({line:{width:"100%",height:2,backgroundColor:ui.semanticColors.BACKGROUND_ACCENT,borderRadius:2147483647}});return React.createElement(View$3,{style:[{marginTop:16,marginBottom:16},addPadding&&{marginHorizontal:16}]},React.createElement(View$3,{style:styles2.line}))}const defaultRoot="https://cloudsync.nexpid.xyz/",defaultClientId="1120793656878714913",api=function(){return vstorage.host?vstorage.host.endsWith("/")?vstorage.host:`${vstorage.host}/`:defaultRoot};var constants={get api(){return api()},raw:`${constants$1.github.raw}plugins/cloud-sync/`,oauth2:{get clientId(){return vstorage.clientId||defaultClientId},get redirectURL(){return`${api()}api/oauth2-response`}}};function _assert_this_initialized(self){if(self===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return self}function _class_call_check(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _construct(Parent,args,Class){return _is_native_reflect_construct()?_construct=Reflect.construct:_construct=function(Parent2,args2,Class2){var a=[null];a.push.apply(a,args2);var Constructor=Function.bind.apply(Parent2,a),instance=new Constructor;return Class2&&_set_prototype_of(instance,Class2.prototype),instance},_construct.apply(null,arguments)}function _get_prototype_of(o){return _get_prototype_of=Object.setPrototypeOf?Object.getPrototypeOf:function(o2){return o2.__proto__||Object.getPrototypeOf(o2)},_get_prototype_of(o)}function _inherits(subClass,superClass){if(typeof superClass!="function"&&superClass!==null)throw new TypeError("Super expression must either be null or a function");subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:!0,configurable:!0}}),superClass&&_set_prototype_of(subClass,superClass)}function _is_native_function(fn){return Function.toString.call(fn).indexOf("[native code]")!==-1}function _possible_constructor_return(self,call){return call&&(_type_of(call)==="object"||typeof call=="function")?call:_assert_this_initialized(self)}function _set_prototype_of(o,p){return _set_prototype_of=Object.setPrototypeOf||function(o2,p2){return o2.__proto__=p2,o2},_set_prototype_of(o,p)}function _type_of(obj){"@swc/helpers - typeof";return obj&&typeof Symbol<"u"&&obj.constructor===Symbol?"symbol":typeof obj}function _wrap_native_super(Class){var _cache2=typeof Map=="function"?new Map:void 0;return _wrap_native_super=function(Class2){if(Class2===null||!_is_native_function(Class2))return Class2;if(typeof Class2!="function")throw new TypeError("Super expression must either be null or a function");if(typeof _cache2<"u"){if(_cache2.has(Class2))return _cache2.get(Class2);_cache2.set(Class2,Wrapper)}function Wrapper(){return _construct(Class2,arguments,_get_prototype_of(this).constructor)}return Wrapper.prototype=Object.create(Class2.prototype,{constructor:{value:Wrapper,enumerable:!1,writable:!0,configurable:!0}}),_set_prototype_of(Wrapper,Class2)},_wrap_native_super(Class)}function _is_native_reflect_construct(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function _create_super(Derived){var hasNativeReflectConstruct=_is_native_reflect_construct();return function(){var Super=_get_prototype_of(Derived),result;if(hasNativeReflectConstruct){var NewTarget=_get_prototype_of(this).constructor;result=Reflect.construct(Super,arguments,NewTarget)}else result=Super.apply(this,arguments);return _possible_constructor_return(this,result)}}const UserStore$2=metro.findByStoreName("UserStore");let CloudSyncAPIError=function(Error1){_inherits(CloudSyncAPIError2,Error1);var _super=_create_super(CloudSyncAPIError2);function CloudSyncAPIError2(resp){_class_call_check(this,CloudSyncAPIError2);var _this;return _this=_super.call(this,`${resp.status}: ${resp.message}${resp.error?` (${resp.error})`:""}`),_this.name=_this.constructor.name,_this}return CloudSyncAPIError2}(_wrap_native_super(Error));function currentAuthorization(){var _UserStore_getCurrentUser;return vstorage.auth[(_UserStore_getCurrentUser=UserStore$2.getCurrentUser())===null||_UserStore_getCurrentUser===void 0?void 0:_UserStore_getCurrentUser.id]}async function getAuthorization(){const e=new Error(lang.format("toast.api.unauthorized",{}));let auth=currentAuthorization();if(!auth)throw e;if(Date.now()>=auth.expiresAt){const x=await fetch(`${constants.api}api/refresh-access-token?refresh_token=${encodeURIComponent(auth.refreshToken)}`);if(x.status!==200)throw new CloudSyncAPIError(await x.json());auth=await x.json(),vstorage.auth[UserStore$2.getCurrentUser().id]=auth}return auth.accessToken}async function getOauth2Response(code){const res=await fetch(`${constants.api}api/get-access-token?code=${encodeURIComponent(code)}`);if(res.status===200)return await res.json();throw new CloudSyncAPIError(await res.json())}async function getSaveData(){if(!currentAuthorization())return;const res=await fetch(`${constants.api}api/get-data`,{headers:{authorization:await getAuthorization()}});if(res.status===200)return await res.json();throw new CloudSyncAPIError(await res.json())}async function syncSaveData(data){if(!currentAuthorization())return;const res=await fetch(`${constants.api}api/sync-data`,{method:"POST",headers:{authorization:await getAuthorization(),"content-type":"application/json"},body:JSON.stringify(data)});if(res.status===200)return await res.json();throw new CloudSyncAPIError(await res.json())}async function deleteSaveData(){if(!currentAuthorization())return;const res=await fetch(`${constants.api}api/delete-data`,{method:"DELETE",headers:{authorization:await getAuthorization()}});if(res.status===200)return await res.json();throw new CloudSyncAPIError(await res.json())}async function uploadFile(body){if(!currentAuthorization())return;const res=await fetch("https://hst.sh/documents",{method:"POST",body});if(res.status===200)return await res.json();throw new CloudSyncAPIError(await res.json())}const{pushModal,popModal}=metro.findByProps("pushModal","popModal"),OAuth2AuthorizeModal=metro.findByName("OAuth2AuthorizeModal"),UserStore$1=metro.findByStoreName("UserStore");function openOauth2Modal(){pushModal({key:"oauth2-authorize",modal:{key:"oauth2-authorize",modal:OAuth2AuthorizeModal,animation:"slide-up",shouldPersistUnderModals:!1,props:{clientId:constants.oauth2.clientId,redirectUri:constants.oauth2.redirectURL,scopes:["identify"],responseType:"code",permissions:0n,cancelCompletesFlow:!1,callback:async function(param){let{location}=param;if(location)try{const code=new URL(location).searchParams.get("code"),token=await getOauth2Response(code);vstorage.auth[UserStore$1.getCurrentUser().id]=token,fillCache(),toasts.showToast(lang.format("toast.oauth.authorized",{}),assets.getAssetIDByName("Check"))}catch(e){toasts.showToast(String(e),assets.getAssetIDByName("Small"))}},dismissOAuthModal:function(){return popModal("oauth2-authorize")}},closable:!0}})}async function makeSound(url){let defaultDuration=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;const id=Math.floor(Math.random()*1e6),duration=await Promise.resolve(new Promise(function(res){return RNSoundManager.prepare(url,"notification",id,function(_,meta){return res(meta?.duration??defaultDuration)})}));let playingTimeout=null;return{play(){playingTimeout&&(clearTimeout(playingTimeout),playingTimeout=null,RNSoundManager.stop(id)),RNSoundManager.play(id),playingTimeout=setTimeout(function(){playingTimeout=null,RNSoundManager.stop(id)},duration)}}}let isInPage=!1,logged;const logs=[];function clearLogs(){logs.length=0,logged?.()}function addLog(scope,message){logs.push([scope,message]),logged?.()}const logScopes={themes:"#42f5a4",plugins:"#4290f5",importer:"#e6f542"},styles$2=common.stylesheet.createThemedStyleSheet({text:{fontFamily:common.constants.Fonts.CODE_SEMIBOLD||common.constants.Fonts.CODE_NORMAL,includeFontPadding:!1,color:ui.semanticColors.TEXT_NORMAL,marginHorizontal:12,marginTop:24}}),ImportLogsPage=function(){const[_,forceUpdate]=common.React.useReducer(function(x){return~x},0);logged=forceUpdate;const scroller=common.React.useRef();return common.React.useEffect(function(){return isInPage=!0,function(){isInPage=!1}},[]),common.React.createElement(common.ReactNative.ScrollView,{style:{flex:1},ref:scroller,onContentSizeChange:function(){return scroller.current.scrollToEnd({animated:!0})}},common.React.createElement(common.ReactNative.Text,{style:styles$2.text},logs.map(function(param){let[scope,message]=param;return[common.React.createElement(common.ReactNative.Text,{style:[styles$2.text,{color:logScopes[scope]}]},"[",lang.format(`log.${scope}`,{}),"]:"),` ${message}
`]})))};function openImportLogsPage(navigation){navigation.push("VendettaCustomPage",{render:ImportLogsPage,title:lang.format("page.import_logs",{})})}async function grabEverything(){const sync={themes:[],plugins:[]};for(const x of Object.values(plugins.plugins)){const config=vstorage.pluginSettings[x.id];if(config?.syncPlugin===!1)continue;const options=config?.syncStorage===!1?{}:await storage.createMMKVBackend(x.id).get();sync.plugins.push({id:x.id,enabled:x.enabled,options})}for(const x of Object.values(themes.themes))sync.themes.push({id:x.id,enabled:x.selected});return sync}let importCallback;function setImportCallback(fnc){importCallback=fnc}async function importData(save,options){var _ithemes_find;if(!save)return;importCallback?.(!0);const iplugins=[...save.sync.plugins.filter(function(x){return!plugins.plugins[x.id]&&!isPluginProxied(x.id)&&canImport(x.id)&&options.unproxiedPlugins}),...save.sync.plugins.filter(function(x){return!plugins.plugins[x.id]&&isPluginProxied(x.id)&&canImport(x.id)&&options.plugins})],ithemes=save.sync.themes.filter(function(x){return!themes.themes[x.id]&&options.themes});if(!iplugins[0]&&!ithemes[0])return importCallback?.(!1),toasts.showToast(lang.format("toast.sync.no_import",{}),assets.getAssetIDByName("Small"));clearLogs(),addLog("importer",lang.format("log.import.start.combo",{plugins:lang.format("plugins",{plugins:iplugins.length}),themes:lang.format("themes",{themes:ithemes.length})})),isInPage||toasts.showToast(lang.format("log.import.start.combo",{plugins:lang.format("plugins",{plugins:iplugins.length}),themes:lang.format("themes",{themes:ithemes.length})}),assets.getAssetIDByName("toast_image_saved"));const status={plugins:0,themes:0,fPlugins:0,fThemes:0};await Promise.all([...iplugins.map(function(x){return new Promise(function(res){RNMMKVManager.setItem(x.id,JSON.stringify(x.options)),plugins.installPlugin(x.id,x.enabled).then(function(){status.plugins++,addLog("plugins",lang.format("log.import.plugin.success",{name:x.id}))}).catch(function(e){status.fPlugins++,addLog("plugins",lang.format("log.import.plugin.fail",{name:x.id,error:e}))}).finally(res)})}),...ithemes.map(function(x){return new Promise(function(res){return themes.installTheme(x.id).then(function(){status.themes++,addLog("themes",lang.format("log.import.theme.success",{name:x.id}))}).catch(function(e){status.fThemes++,addLog("themes",lang.format("log.import.theme.fail",{name:x.id,error:e}))}).finally(res)})})]),isInPage||toasts.showToast(lang.format("log.import.total",{plugins:lang.format("plugins",{plugins:status.plugins}),themes:lang.format("themes",{themes:status.themes})}),assets.getAssetIDByName("Check"));const selectTheme=themes.themes[(_ithemes_find=ithemes.find(function(x){return x.enabled}))===null||_ithemes_find===void 0?void 0:_ithemes_find.id];selectTheme&&(addLog("themes",lang.format("log.import.select_theme",{theme:selectTheme.id})),await storage.createFileBackend("vendetta_theme.json").set(Object.assign(selectTheme,{selected:!0})),await function(){return new Promise(function(res){return alerts.showConfirmationAlert({title:lang.format("alert.change_theme.title",{}),content:lang.format("alert.change_theme.body",{}),confirmText:lang.format("alert.change_theme.confirm",{}),confirmColor:"red",onConfirm:function(){RNBundleUpdaterManager.reload(),res()},cancelText:lang.format("alert.change_theme.cancel",{}),onCancel:res,isDismissable:!0})})}()),addLog("importer",status.fPlugins||status.fThemes?lang.format("log.import.result.fail",{plugins:lang.format("plugins",{plugins:status.plugins}),themes:lang.format("themes",{themes:status.themes}),failed_plugins:lang.format("plugins",{plugins:status.fPlugins}),failed_themes:lang.format("themes",{themes:status.fThemes})}):lang.format("log.import.result.success",{plugins:lang.format("plugins",{plugins:status.plugins}),themes:lang.format("themes",{themes:status.themes})})),importCallback?.(!1)}var cryptoWebview=`<!doctype html>
<html></html>
<script>
  const RNWV = window.ReactNativeWebView;

  const stringToBuffer = (string) => new TextEncoder().encode(string);
  const bufferToString = (buffer) => new TextDecoder().decode(buffer);

  const keyCache = {};
  const getKey = async (raw) => {
    if (keyCache[raw]) return keyCache[raw];

    const pkey = await crypto.subtle.importKey(
      "raw",
      stringToBuffer(raw),
      { name: "PBKDF2" },
      false,
      ["deriveKey"],
    );
    const key = await crypto.subtle.deriveKey(
      {
        name: "PBKDF2",
        salt: new Uint8Array(16),
        iterations: 100000,
        hash: "SHA-256",
      },
      pkey,
      { name: "AES-GCM", length: 256 },
      false,
      ["encrypt", "decrypt"],
    );
    keyCache[raw] = key;
    return key;
  };

  window.addEventListener("message", async (ev) => {
    const { action, data, key, tracker } = ev.data;
    if (!action || !data || !key || !tracker) return;

    try {
      if (action === "encrypt") {
        const iv = crypto.getRandomValues(new Uint8Array(12));
        const ret = await window.crypto.subtle.encrypt(
          {
            name: "AES-GCM",
            iv,
          },
          await getKey(key),
          stringToBuffer(data),
        );
        return RNWV.postMessage(
          JSON.stringify({
            tracker,
            data: btoa(
              String.fromCharCode
                .apply(null, iv)
                .concat(String.fromCharCode.apply(null, new Uint8Array(ret))),
            ),
          }),
        );
      } else if (action === "decrypt") {
        const raw = atob(data);
        const iv = new Uint8Array(
          raw
            .slice(0, 12)
            .split("")
            .map((x) => x.charCodeAt(0)),
        );
        const dt = new Uint8Array(
          raw
            .slice(12)
            .split("")
            .map((x) => x.charCodeAt(0)),
        );

        const ret = await window.crypto.subtle.decrypt(
          {
            name: "AES-GCM",
            iv,
          },
          await getKey(key),
          dt,
        );
        return RNWV.postMessage(
          JSON.stringify({ tracker, data: bufferToString(ret) }),
        );
      }
    } catch (e) {
      return RNWV.postMessage(
        JSON.stringify({ tracker, error: e.message ?? \`\${e}\` }),
      );
    }
  });
<\/script>
`;let handler;const handlers={},makeTracker=function(){return Math.floor(Math.random()*1e36).toString(36)},sendMessage=function(data){return handler?.injectJavaScript(`window.postMessage(${JSON.stringify(data)})`)};async function encrypt(data,key){if(!handler)return null;const tracker=makeTracker();return new Promise(function(res,rej){handlers[tracker]=function(r){return"error"in r?rej(r.error):res(r.data)},sendMessage({action:"encrypt",data,key,tracker})})}async function decrypt(data,key){if(!handler)return null;const tracker=makeTracker();return new Promise(function(res,rej){handlers[tracker]=function(r){return"error"in r?rej(r.error):res(r.data)},sendMessage({action:"decrypt",data,key,tracker})})}function CryptoWebViewHandler(){return common.React.useEffect(function(){return function(){return handler=void 0}},[]),common.React.createElement(WebView,{ref:function(e){return handler=e},source:{html:cryptoWebview,baseUrl:"https://localhost"},style:{display:"none",opacity:0},onMessage:function(param){let{nativeEvent:{data}}=param;var _handlers_res_tracker;let res;try{res=JSON.parse(data)}catch{return}(_handlers_res_tracker=handlers[res.tracker])===null||_handlers_res_tracker===void 0||_handlers_res_tracker.call(handlers,res)}})}const{View:View$2,Text}=components.General,styles$1=common.stylesheet.createThemedStyleSheet({count:{...TextStyleSheet["text-lg/bold"],color:ui.semanticColors.TEXT_NORMAL,textAlign:"center"},subtitle:{...TextStyleSheet["text-md/medium"],color:ui.semanticColors.TEXT_MUTED,textAlign:"center"}});function DataStat(param){let{subtitle,count}=param;return React.createElement(View$2,{style:{alignItems:"center",justifyContent:"center",marginHorizontal:16}},React.createElement(Text,{style:styles$1.count},count),React.createElement(Text,{style:styles$1.subtitle},lang.format(subtitle,{})))}function SuperAwesomeIcon(param){let{onPress,onLongPress,icon,style,destructive,color}=param;const styles2=common.stylesheet.createThemedStyleSheet({headerStyleIcon:{width:24,height:24,marginRight:10,tintColor:ui.semanticColors.HEADER_PRIMARY},cardStyleIcon:{width:22,height:22,marginLeft:5,tintColor:ui.semanticColors.INTERACTIVE_NORMAL},destructiveIcon:{tintColor:ui.semanticColors.TEXT_DANGER}});return React.createElement(common.ReactNative.TouchableOpacity,{onPress,onLongPress},React.createElement(common.ReactNative.Image,{style:[typeof style=="string"?style==="header"?styles2.headerStyleIcon:styles2.cardStyleIcon:style,destructive&&styles2.destructiveIcon,color&&{tintColor:color}].filter(function(x){return!!x}),source:icon}))}function managePage(options,navigation){for(var _len=arguments.length,deps=new Array(_len>2?_len-2:0),_key=2;_key<_len;_key++)deps[_key-2]=arguments[_key];navigation||(navigation=common.NavigationNative.useNavigation()),common.React.useEffect(function(){navigation.setOptions(options)},[navigation,...deps])}const{FormSwitchRow:FormSwitchRow$1}=components.Forms;function PluginSettingsPage(){const[search,setSearch]=common.React.useState(""),[,forceUpdate]=common.React.useReducer(function(x){return~x},0);return common.React.useEffect(function(){setSearch("")},[]),storage.useProxy(vstorage),managePage({title:lang.format("page.plugin_settings.title",{}),headerRight:function(){return common.React.createElement(SuperAwesomeIcon,{onPress:function(){return alerts.showConfirmationAlert({title:lang.format("alert.plugin_settings_revert.title",{}),content:lang.format("alert.plugin_settings_revert.body",{}),confirmText:lang.format("alert.plugin_settings_revert.confirm",{}),confirmColor:"red",onConfirm:function(){return vstorage.pluginSettings={}}})},icon:assets.getAssetIDByName("ic_message_delete"),style:"header"})}}),common.React.createElement(common.ReactNative.FlatList,{ListHeaderComponent:common.React.createElement(components.Search,{style:{marginBottom:10},onChangeText:function(x){return setSearch(x.toLowerCase())}}),style:{paddingHorizontal:10,paddingTop:10},contentContainerStyle:{paddingBottom:20},data:Object.entries(plugins.plugins).filter(function(x){var _x__manifest_name;return(_x__manifest_name=x[1].manifest.name)===null||_x__manifest_name===void 0?void 0:_x__manifest_name.toLowerCase().includes(search)}),renderItem:function(param){let{item:[id,item]}=param;const config=vstorage.pluginSettings[id]??{syncPlugin:!0,syncStorage:!0},updateConfig=function(){config.syncPlugin===!0&&config.syncStorage===!0?delete vstorage.pluginSettings[id]:vstorage.pluginSettings[id]=config,forceUpdate()};return common.React.createElement(components.Summary,{label:item.manifest.name,icon:item.manifest.vendetta.icon??":3"},common.React.createElement(FormSwitchRow$1,{label:lang.format("page.plugin_settings.sync_plugin",{}),onValueChange:function(){config.syncPlugin=!config.syncPlugin,updateConfig()},value:config.syncPlugin}),common.React.createElement(FormSwitchRow$1,{label:lang.format("page.plugin_settings.sync_plugin_storage",{}),onValueChange:function(){config.syncStorage=!config.syncStorage,updateConfig()},value:config.syncStorage}))}})}const OhFuck=function(prop){return function(){return common.React.useEffect(function(){toasts.showToast("Uh oh, something broke! Search for fckp in Debug Logs!"),console.warn(`Uh oh (fckp)!!
Missing the redesign component: ${prop}. Please bug @nexpid about this on Discord!`)},[]),null}},OhFuckFunction=function(prop){return function(){return toasts.showToast("Uh oh, something broke! Search for fckp in Debug Logs!"),console.warn(`Uh oh (fckp)!!
Missing the redesign function: ${prop}. Please bug @nexpid about this on Discord!`),null}},findThing=function(){for(var _len=arguments.length,props=new Array(_len),_key=0;_key<_len;_key++)props[_key]=arguments[_key];var _findByProps5;return(_findByProps5=metro.findByProps(...props))===null||_findByProps5===void 0?void 0:_findByProps5[props[0]]},findThingRequired=function(){for(var _len=arguments.length,props=new Array(_len),_key=0;_key<_len;_key++)props[_key]=arguments[_key];return findThing(...props)??OhFuck(props[0])},findFuncRequired=function(){for(var _len=arguments.length,props=new Array(_len),_key=0;_key<_len;_key++)props[_key]=arguments[_key];return findThing(...props)??OhFuckFunction(props[0])},Button=findThingRequired("Button");findThingRequired("RowButton"),findThing("Slider"),findThingRequired("FloatingActionButton"),findThingRequired("TextInput"),findThingRequired("Tabs"),findThingRequired("SegmentedControlPages"),findFuncRequired("useSegmentedControlState");const{View:View$1}=components.General,{FormCheckboxRow}=components.Forms;function ImportActionSheet(param){let{defOptions,save=cache.save,navigation}=param;const has={unproxiedPlugins:save.sync.plugins.filter(function(x){return!plugins.plugins[x.id]&&!isPluginProxied(x.id)&&canImport(x.id)}).length,plugins:save.sync.plugins.filter(function(x){return!plugins.plugins[x.id]&&isPluginProxied(x.id)&&canImport(x.id)}).length,themes:save.sync.themes.filter(function(x){return!themes.themes[x.id]}).length},total=[has.unproxiedPlugins,has.plugins,has.themes].reduce(function(x,a){return x+a},0),[options,setOptions]=common.React.useState(defOptions??{unproxiedPlugins:!1,plugins:!!has.plugins,themes:!!has.themes}),styles2=common.stylesheet.createThemedStyleSheet({icon:{width:18,height:18,tintColor:ui.semanticColors.TEXT_BRAND,marginRight:4},btnIcon:{tintColor:ui.semanticColors.TEXT_NORMAL,marginRight:8}});return common.React.createElement(ActionSheet,null,common.React.createElement(ActionSheetContentContainer,null,common.React.createElement(ActionSheetTitleHeader,{title:lang.format("sheet.import_data.title",{}),trailing:common.React.createElement(ActionSheetCloseButton,{onPress:function(){return hideActionSheet()}})}),!total&&common.React.createElement(common.React.Fragment,null,common.React.createElement(View$1,{style:{flexDirection:"row",alignItems:"center",justifyContent:"center",marginTop:8}},common.React.createElement(common.ReactNative.Image,{source:assets.getAssetIDByName("ic_info_24px"),style:styles2.icon,resizeMode:"cover"}),common.React.createElement(Text$1,{variant:"text-md/semibold",color:"TEXT_BRAND",align:"center"},lang.format("sheet.import_data.already_synced",{})))),common.React.createElement(FormCheckboxRow,{label:lang.format("sheet.import_data.unproxied_plugins",{count:String(has.plugins)}),disabled:!has.unproxiedPlugins,onPress:function(){return has.unproxiedPlugins&&(!options.unproxiedPlugins&&!defOptions?alerts.showConfirmationAlert({title:lang.format("alert.unproxied_plugin_warn.title",{}),content:lang.format("alert.unproxied_plugin_warn.body",{}),isDismissable:!0,confirmText:lang.format("alert.unproxied_plugin_warn.confirm",{}),confirmColor:"brand",onConfirm:function(){return openSheet(ImportActionSheet,{save,navigation,defOptions:{...options,unproxiedPlugins:!0}})}}):setOptions({...options,unproxiedPlugins:!options.unproxiedPlugins}))},selected:options.unproxiedPlugins}),common.React.createElement(FormCheckboxRow,{label:lang.format("sheet.import_data.plugins",{count:String(has.plugins)}),disabled:!has.plugins,onPress:function(){return has.plugins&&setOptions({...options,plugins:!options.plugins})},selected:options.plugins}),common.React.createElement(FormCheckboxRow,{label:lang.format("sheet.import_data.themes",{count:String(has.themes)}),disabled:!has.themes,onPress:function(){return has.themes&&setOptions({...options,themes:!options.themes})},selected:options.themes}),common.React.createElement(Button,{text:lang.format("sheet.import_data.import",{}),variant:"primary",size:"md",iconPosition:"start",icon:assets.getAssetIDByName("DownloadIcon"),onPress:function(){openImportLogsPage(navigation),importData(save,options),hideActionSheet()},style:{marginHorizontal:16,marginVertical:16},disabled:!options.unproxiedPlugins&&!options.plugins&&!options.themes})))}const DocumentPicker=metro.findByProps("pickSingle","isCancel"),{downloadMediaAsset}=metro.findByProps("downloadMediaAsset"),{ScrollView,View}=components.General,{FormRow:FormRow$1,FormInput,FormSwitchRow}=components.Forms,UserStore=metro.findByStoreName("UserStore"),deltaruneCreepyJingle=storage.wrapSync(makeSound(`${constants.raw}assets/snd_creepyjingle.ogg`,1.6)),undertaleMysteryGo=storage.wrapSync(makeSound(`${constants.raw}assets/snd_mysterygo.ogg`,2.2));function Settings(){var _cache_save_sync_plugins,_cache_save_sync,_cache_save,_cache_save_sync_themes,_cache_save_sync1,_cache_save1;const[showDev,setShowDev]=common.React.useState(!1),[isBusy,setIsBusy]=common.React.useState([]);storage.useProxy(cache),storage.useProxy(vstorage);const setBusy=function(x){return!isBusy.includes(x)&&setIsBusy([...isBusy,x])},unBusy=function(x){return setIsBusy(isBusy.filter(function(y){return x!==y}))};let lastTap=0;const navigation=common.NavigationNative.useNavigation(),isAuthed=!!currentAuthorization(),hasData=!!cache.save;return common.React.createElement(ScrollView,null,common.React.createElement(CryptoWebViewHandler,null),common.React.createElement(BetterTableRowGroup,{title:lang.format("settings.current_data.title",{}),icon:assets.getAssetIDByName("ic_contact_sync"),padding:!0},common.React.createElement(View,{style:{flexDirection:"row",alignItems:"center",justifyContent:"center",marginVertical:8}},common.React.createElement(DataStat,{count:((_cache_save=cache.save)===null||_cache_save===void 0||(_cache_save_sync=_cache_save.sync)===null||_cache_save_sync===void 0||(_cache_save_sync_plugins=_cache_save_sync.plugins)===null||_cache_save_sync_plugins===void 0?void 0:_cache_save_sync_plugins.length)??"-",subtitle:"settings.current_data.plugins"}),common.React.createElement(DataStat,{count:((_cache_save1=cache.save)===null||_cache_save1===void 0||(_cache_save_sync1=_cache_save1.sync)===null||_cache_save_sync1===void 0||(_cache_save_sync_themes=_cache_save_sync1.themes)===null||_cache_save_sync_themes===void 0?void 0:_cache_save_sync_themes.length)??"-",subtitle:"settings.current_data.themes"}))),common.React.createElement(BetterTableRowGroup,{title:lang.format("settings.config.title",{}),icon:assets.getAssetIDByName("ic_cog_24px"),onTitlePress:function(){return lastTap>=Date.now()?(showDev?undertaleMysteryGo.play():deltaruneCreepyJingle.play(),setShowDev(!showDev),lastTap=0):lastTap=Date.now()+500}},common.React.createElement(FormSwitchRow,{label:lang.format("settings.config.auto_save.title",{}),subLabel:lang.format("settings.config.auto_save.description",{}),leading:common.React.createElement(FormRow$1.Icon,{source:assets.getAssetIDByName("ic_contact_sync")}),onValueChange:function(){return vstorage.autoSync=!vstorage.autoSync},value:vstorage.autoSync}),!emitterAvailable&&vstorage.autoSync&&common.React.createElement(Text$1,{variant:"text-md/semibold",color:"TEXT_DANGER",style:{marginHorizontal:20,marginVertical:2}},"You must reinstall your client in order to use Auto Save!"),common.React.createElement(FormSwitchRow,{label:lang.format("settings.config.settings_pin.title",{}),subLabel:lang.format("settings.config.settings_pin.description",{}),leading:common.React.createElement(FormRow$1.Icon,{source:assets.getAssetIDByName("ic_message_pin")}),onValueChange:function(){return vstorage.addToSettings=!vstorage.addToSettings},value:vstorage.addToSettings}),common.React.createElement(FormRow$1,{label:lang.format("page.plugin_settings.title",{}),leading:common.React.createElement(FormRow$1.Icon,{source:assets.getAssetIDByName("debug")}),trailing:common.React.createElement(FormRow$1.Arrow,null),onPress:function(){return navigation.push("VendettaCustomPage",{render:PluginSettingsPage})}}),showDev&&common.React.createElement(common.React.Fragment,null,common.React.createElement(LineDivider,{addPadding:!0}),common.React.createElement(FormRow$1,{label:lang.format("settings.dev.api_url.title",{}),subLabel:lang.format("settings.dev.api_url.description",{}),leading:common.React.createElement(FormRow$1.Icon,{source:assets.getAssetIDByName("ic_message_edit")})}),common.React.createElement(FormInput,{title:"",placeholder:defaultRoot,value:constants.api,onChange:function(x){return vstorage.host=x||defaultRoot},style:{marginTop:-25,marginHorizontal:12}}),common.React.createElement(FormRow$1,{label:lang.format("settings.dev.client_id.title",{}),subLabel:lang.format("settings.dev.client_id.description",{}),leading:common.React.createElement(FormRow$1.Icon,{source:assets.getAssetIDByName("ic_message_edit")})}),common.React.createElement(FormInput,{title:"",placeholder:defaultClientId,value:constants.oauth2.clientId,onChange:function(x){return vstorage.clientId=x||defaultClientId},style:{marginTop:-25,marginHorizontal:12}}))),common.React.createElement(BetterTableRowGroup,{title:lang.format("settings.auth.title",{}),icon:assets.getAssetIDByName("lock")},currentAuthorization()?common.React.createElement(common.React.Fragment,null,common.React.createElement(FormRow$1,{label:lang.format("settings.auth.log_out.title",{}),subLabel:lang.format("settings.auth.log_out.description",{}),leading:common.React.createElement(FormRow$1.Icon,{source:assets.getAssetIDByName("ic_logout_24px")}),onPress:function(){return alerts.showConfirmationAlert({title:lang.format("alert.log_out.title",{}),content:lang.format("alert.log_out.body",{}),confirmColor:"BRAND",onConfirm:function(){delete vstorage.auth[UserStore.getCurrentUser().id],delete cache.save,toasts.showToast(lang.format("toast.logout",{}),assets.getAssetIDByName("ic_logout_24px"))}})}}),common.React.createElement(FormRow$1,{label:lang.format("settings.auth.delete_data.title",{}),subLabel:lang.format("settings.auth.delete_data.description",{}),leading:common.React.createElement(FormRow$1.Icon,{source:assets.getAssetIDByName("trash")}),onPress:function(){return alerts.showConfirmationAlert({title:lang.format("alert.delete_data.title",{}),content:lang.format("alert.delete_data.body",{}),confirmText:lang.format("alert.delete_data.confirm",{}),confirmColor:"RED",onConfirm:async function(){await deleteSaveData(),delete vstorage.auth[UserStore.getCurrentUser().id],delete cache.save,toasts.showToast(lang.format("toast.deleted_data",{}),assets.getAssetIDByName("trash"))}})}})):common.React.createElement(FormRow$1,{label:lang.format("settings.auth.authorize",{}),leading:common.React.createElement(FormRow$1.Icon,{source:assets.getAssetIDByName("copy")}),trailing:FormRow$1.Arrow,onPress:openOauth2Modal})),common.React.createElement(BetterTableRowGroup,{title:lang.format("settings.data.title",{}),icon:assets.getAssetIDByName("ic_message_edit"),padding:!isAuthed||!hasData},isAuthed&&hasData?common.React.createElement(common.React.Fragment,null,common.React.createElement(FormRow$1,{label:lang.format("settings.data.save_data.title",{}),subLabel:lang.format("settings.data.save_data.description",{}),leading:isBusy.includes("save_api")?common.React.createElement(common.ReactNative.ActivityIndicator,{size:"small"}):common.React.createElement(FormRow$1.Icon,{source:assets.getAssetIDByName("ic_file_upload_24px")}),onPress:function(){return alerts.showConfirmationAlert({title:lang.format("alert.save_data.title",{}),content:lang.format("alert.save_data.body",{}),confirmText:lang.format("alert.save_data.confirm",{}),confirmColor:"BRAND",onConfirm:async function(){setBusy("save_api");try{cache.save=await syncSaveData(await grabEverything()),toasts.showToast(lang.format("toast.saved_data",{}),assets.getAssetIDByName("Check"))}catch(e){toasts.showToast(String(e),assets.getAssetIDByName("Small"))}unBusy("save_api")}})}}),common.React.createElement(FormRow$1,{label:lang.format("sheet.import_data.title",{}),subLabel:lang.format("settings.data.import_data.description",{}),leading:isBusy.includes("import_api")?common.React.createElement(common.ReactNative.ActivityIndicator,{size:"small"}):common.React.createElement(FormRow$1.Icon,{source:assets.getAssetIDByName("ic_download_24px")}),onPress:function(){openSheet(ImportActionSheet,{navigation}),setImportCallback(function(x){return x?setBusy("import_api"):unBusy("import_api")})}}),common.React.createElement(LineDivider,{addPadding:!0}),common.React.createElement(FormRow$1,{label:lang.format("settings.data.export_local_data.title",{}),subLabel:lang.format("settings.data.export_local_data.description",{}),leading:isBusy.includes("export_local")?common.React.createElement(common.ReactNative.ActivityIndicator,{size:"small"}):common.React.createElement(FormRow$1.Icon,{source:assets.getAssetIDByName("ic_file_upload_24px")}),onPress:async function(){alerts.showInputAlert({title:lang.format("alert.encryption_key.title",{}),placeholder:lang.format("alert.encryption_key.placeholder",{}),confirmText:lang.format("alert.encryption_key.confirm",{}),onConfirm:async function(inp){if(!inp)throw new Error(lang.format("alert.encryption_key.required",{}));if(isBusy.length)return;setBusy("local_export");let text;try{text=await encrypt(JSON.stringify(cache.save),inp)}catch{return unBusy("local_export"),toasts.showToast(lang.format("toast.encrypt_fail",{}),assets.getAssetIDByName("Small"))}if(RNFS.hasRNFS){const file=`CloudSync_${Math.floor(Math.random()*1e4)}.txt`;RNFS.writeFile(RNFS.DownloadDirectoryPath+`/${file}`,text),toasts.showToast(lang.format("toast.backup_saved",{file}),assets.getAssetIDByName("ic_file_small_document"))}else{toasts.showToast(lang.format("toast.backup_download_prepare",{}),assets.getAssetIDByName("ic_upload"));let data;try{data=await uploadFile(text)}catch(e){return unBusy("local_export"),toasts.showToast(e?.message??`${e}`,assets.getAssetIDByName("Small"))}toasts.showToast(lang.format("toast.backup_saved",{file:data.key}),assets.getAssetIDByName("ic_file_small_document")),downloadMediaAsset(`https://hst.sh/raw/${data.key}.txt`,3)}unBusy("local_export")}})}}),common.React.createElement(FormRow$1,{label:lang.format("settings.data.import_local_data.title",{}),subLabel:lang.format("settings.data.import_local_data.description",{}),leading:isBusy.includes("import_local")?common.React.createElement(common.ReactNative.ActivityIndicator,{size:"small"}):common.React.createElement(FormRow$1.Icon,{source:assets.getAssetIDByName("ic_download_24px")}),onPress:async function(){if(isBusy.length)return;setBusy("import_local");let text;try{const{fileCopyUri,type}=await DocumentPicker.pickSingle({type:DocumentPicker.types.plainText,mode:"open",copyTo:"cachesDirectory"});(type==="text/plain"||!fileCopyUri)&&(text=await RNFS.readFile(fileCopyUri.slice(5),"utf8"))}catch(e){DocumentPicker.isCancel(e)||toasts.showToast(lang.format("toast.errored",{error:e}),assets.getAssetIDByName("Small"))}unBusy("import_local"),text&&alerts.showInputAlert({title:lang.format("alert.decryption_key.title",{}),placeholder:lang.format("alert.decryption_key.placeholder",{}),confirmText:lang.format("alert.decryption_key.confirm",{}),onConfirm:async function(inp){if(!inp)throw new Error(lang.format("alert.decryption_key.required",{}));if(!isBusy.length){setBusy("import_local");try{const data=JSON.parse(await decrypt(text,inp));openSheet(ImportActionSheet,{save:data,navigation}),unBusy("import_local"),setImportCallback(function(x){return x?setBusy("import_local"):unBusy("import_local")})}catch{return unBusy("import_local"),toasts.showToast(lang.format("toast.decrypt_fail",{}),assets.getAssetIDByName("Small"))}}}})}})):isAuthed?common.React.createElement(common.ReactNative.ActivityIndicator,{size:"small",style:{flex:1}}):common.React.createElement(Text$1,{variant:"text-md/semibold",color:"TEXT_NORMAL",align:"center"},lang.format("settings.label.auth_needed",{}))),common.React.createElement(View,{style:{height:12}}))}let syncTimeout=0;function hsync(run){clearTimeout(syncTimeout),syncTimeout=setTimeout(run,1500)}const{FormSection}=components.Forms,getScreens=metro.findByName("getScreens"),settingsModule=metro.findByName("UserSettingsOverviewWrapper",!1),styles=common.stylesheet.createThemedStyleSheet({container:{flex:1,backgroundColor:ui.semanticColors.BACKGROUND_MOBILE_PRIMARY}});function patchSettingsPin(shouldAppear,render,you){const patches2=[],unpatch=patcher$1.after("default",settingsModule,function(_,ret){unpatch();const Overview=utils.findInReactTree(ret.props.children,function(i){return i.type&&i.type.name==="UserSettingsOverview"});patches2.push(patcher$1.after("render",Overview.type.prototype,function(_2,param){let{props:{children}}=param;const titles=[common.i18n.Messages.BILLING_SETTINGS,common.i18n.Messages.PREMIUM_SETTINGS];children=utils.findInReactTree(children,function(t){return t.children[1].type===FormSection}).children;const index2=children.findIndex(function(c){return titles.includes(c?.props.label)});shouldAppear()&&children.splice(index2===-1?4:index2,0,render({}))}))},!0);if(patches2.push(unpatch),getScreens&&you){const screenKey=`BUNNY_PLUGIN_${common.lodash.snakeCase(you.key).toUpperCase()}`,Page=you.page.render,component=common.React.memo(function(param){let{navigation}=param;return managePage(utils.without({...you.page,title:you.title()},"noErrorBoundary","render"),navigation),common.React.createElement(common.ReactNative.View,{style:styles.container},you.page.noErrorBoundary?common.React.createElement(Page,null):common.React.createElement(components.ErrorBoundary,null,common.React.createElement(Page,null)))});let predicateReq=!0;patches2.push(function(){return predicateReq=!1});const rendererConfig={[screenKey]:{type:"route",title:function(){return you.title()},usePredicate:function(){return predicateReq&&(shouldAppear?shouldAppear():!0)},useTrailing:you.trailing,icon:you.icon,parent:null,screen:{route:`BunnyPlugin${common.lodash.chain(you.key).camelCase().upperFirst().value()}`,getComponent:function(){return component}}}},manipulateSections=function(ret,nw){var _cloned_,_section_settings;const cloned=[...ret],sections=nw?cloned==null||(_cloned_=cloned[0])===null||_cloned_===void 0?void 0:_cloned_.sections:cloned;if(!Array.isArray(sections))return sections;const title="Bunny",section=sections.find(function(x){return x?.title===title||x?.label===title});return section&&!(!(section==null||(_section_settings=section.settings)===null||_section_settings===void 0)&&_section_settings.includes(screenKey))&&section.settings.push(screenKey),cloned},oldYouPatch=function(){const layout=metro.findByProps("useOverviewSettings"),titleConfig=metro.findByProps("getSettingTitleConfig"),stuff=metro.findByProps("SETTING_RELATIONSHIPS","SETTING_RENDERER_CONFIGS"),OLD_getterFunction="getSettingSearchListItems",NEW_getterFunction="getSettingListItems",oldGettersModule=metro.findByProps(OLD_getterFunction),getterFunctionName=oldGettersModule?OLD_getterFunction:NEW_getterFunction,getters=oldGettersModule??metro.findByProps(NEW_getterFunction);if(!getters||!layout)return!1;patches2.push(patcher$1.after("useOverviewSettings",layout,function(_,ret){return manipulateSections(ret)})),patches2.push(patcher$1.after("getSettingTitleConfig",titleConfig,function(_,ret){return{...ret,[screenKey]:you.title}})),patches2.push(patcher$1.after(getterFunctionName,getters,function(param,ret){let[settings]=param;return[...settings.includes(screenKey)?[{type:"setting_search_result",ancestorRendererData:rendererConfig[screenKey],setting:screenKey,title:function(){return you.title},breadcrumbs:["Bunny","Nexpid"],icon:rendererConfig[screenKey].icon}]:[],...ret]}));const oldRelationships=stuff.SETTING_RELATIONSHIPS,oldRendererConfigs=stuff.SETTING_RENDERER_CONFIGS;return stuff.SETTING_RELATIONSHIPS={...oldRelationships,[screenKey]:null},stuff.SETTING_RENDERER_CONFIGS={...oldRendererConfigs,...rendererConfig},patches2.push(function(){stuff.SETTING_RELATIONSHIPS=oldRelationships,stuff.SETTING_RENDERER_CONFIGS=oldRelationships}),!0};(function(){const settingsListComponents=metro.findByProps("SearchableSettingsList"),settingConstantsModule=metro.findByProps("SETTING_RENDERER_CONFIG"),gettersModule=metro.findByProps("getSettingListItems");if(!gettersModule||!settingsListComponents||!settingConstantsModule)return!1;patches2.push(patcher$1.before("type",settingsListComponents.SearchableSettingsList,function(ret){return manipulateSections(ret,!0)})),patches2.push(patcher$1.after("getSettingListSearchResultItems",gettersModule,function(_,ret){for(const s of ret)s.setting===screenKey&&(s.breadcrumbs=["Bunny","Nexpid"])}));const oldRendererConfig=settingConstantsModule.SETTING_RENDERER_CONFIG;return settingConstantsModule.SETTING_RENDERER_CONFIG={...oldRendererConfig,...rendererConfig},patches2.push(function(){settingConstantsModule.SETTING_RENDERER_CONFIG=oldRendererConfig}),!0})()||oldYouPatch()}return function(){return patches2.forEach(function(x){return x()})}}const{FormRow}=components.Forms;function SettingsSection(){const navigation=common.NavigationNative.useNavigation();return React.createElement(components.ErrorBoundary,null,React.createElement(FormRow,{label:lang.format("plugin.name",{}),leading:React.createElement(FormRow.Icon,{source:assets.getAssetIDByName("ic_contact_sync")}),trailing:FormRow.Arrow,onPress:function(){return navigation.push("VendettaCustomPage",{title:lang.format("plugin.name",{}),render:Settings})}}))}function patcher(){const patches2=[];return patches2.push(patchSettingsPin(function(){return vstorage.addToSettings},function(){return React.createElement(SettingsSection,null)},{key:_vendetta.plugin.manifest.name,icon:assets.getAssetIDByName("ic_contact_sync"),title:function(){return lang.format("plugin.name",{})},page:{render:Settings}})),function(){return patches2.forEach(function(x){return x()})}}const vstorage=plugin.storage;let _cache;const cache=storage.wrapSync(storage.createStorage({get:function(){return _cache},set:function(x){_cache=x}})),fillCache=async function(){return getSaveData().then(function(x){return cache.save=x})};function isPluginProxied(id){return id.startsWith(_vendetta.constants.PROXY_PREFIX)}function canImport(id){return!id.includes("cloud-sync")}const autoSync=async function(){if(!vstorage.autoSync)return;const everything=await grabEverything();JSON.stringify(cache.save)!==JSON.stringify(everything)&&hsync(async function(){return cache.save=await syncSaveData(everything)})},emitterSymbol=Symbol.for("vendetta.storage.emitter"),emitterAvailable=!!plugins.plugins[emitterSymbol]&&!!themes.themes[emitterSymbol],lang=new Lang("cloud_sync"),patches=[];var index={onLoad:function(){if(vstorage.autoSync??(vstorage.autoSync=!1),vstorage.addToSettings??(vstorage.addToSettings=!1),vstorage.pluginSettings??(vstorage.pluginSettings={}),vstorage.auth??(vstorage.auth={}),currentAuthorization()&&fillCache(),emitterAvailable){const emitters={plugins:plugins.plugins[emitterSymbol],themes:themes.themes[emitterSymbol]};emitters.plugins.on("SET",autoSync),emitters.themes.on("SET",autoSync),emitters.plugins.on("DEL",autoSync),emitters.themes.on("DEL",autoSync),patches.push(function(){emitters.plugins.off("SET",autoSync),emitters.themes.off("SET",autoSync),emitters.plugins.off("DEL",autoSync),emitters.themes.off("DEL",autoSync)})}patches.push(patcher()),plugin.storage.databaseMigrate&&delete plugin.storage.databaseMigrate},onUnload:function(){return patches.forEach(function(x){return x()})},settings:Settings};return exports.cache=cache,exports.canImport=canImport,exports.default=index,exports.emitterAvailable=emitterAvailable,exports.fillCache=fillCache,exports.isPluginProxied=isPluginProxied,exports.lang=lang,exports.vstorage=vstorage,Object.defineProperty(exports,"__esModule",{value:!0}),exports})({},vendetta,vendetta.plugin,vendetta.plugins,vendetta.storage,vendetta.themes,vendetta.metro,vendetta.metro.common,vendetta.ui.alerts,vendetta.ui.assets,vendetta.ui.components,vendetta.ui.toasts,vendetta.ui,vendetta.patcher,vendetta.utils);
