(function(exports,_vendetta,constants,metro,common,patcher$1,plugins,assets,toasts,ui){"use strict";const MessageStore=metro.findByStoreName("MessageStore"),pluginInstallingCache={},pluginMessageCache={},updateMessages=function(plugin,installing){if(installing!==void 0&&(pluginInstallingCache[plugin]=installing),pluginMessageCache[plugin])for(const[id,channel]of pluginMessageCache[plugin]){const message=MessageStore.getMessage(channel,id);message&&common.FluxDispatcher.dispatch({type:"MESSAGE_UPDATE",message:{...message,content:message.content.endsWith(" ")?message.content.slice(0,-1):message.content+" "},log_edit:!1})}};var _findByProps,_findByProps1,_findByProps2;const ThemeStore=metro.findByStoreName("ThemeStore");metro.findByProps("triggerHaptic");const colorModule=metro.findByProps("colors","unsafe_rawColors"),colorResolver=colorModule?.internal??colorModule?.meta;metro.findByProps("TextStyleSheet").TextStyleSheet,metro.findByName("Navigator")??((_findByProps=metro.findByProps("Navigator"))===null||_findByProps===void 0||_findByProps.Navigator),((_findByProps1=metro.findByProps("getRenderCloseButton"))===null||_findByProps1===void 0?void 0:_findByProps1.getRenderCloseButton)??((_findByProps2=metro.findByProps("getHeaderCloseButton"))===null||_findByProps2===void 0||_findByProps2.getHeaderCloseButton),metro.findByProps("popModal","pushModal");function resolveSemanticColor(color){let theme=arguments.length>1&&arguments[1]!==void 0?arguments[1]:ThemeStore.theme;return colorResolver.resolveSemanticColor(theme,color)}function androidifyColor(color){let alpha=arguments.length>1&&arguments[1]!==void 0?arguments[1]:255;const[_,r,g,b]=color.match(/#([A-F0-9]{2})([A-F0-9]{2})([A-F0-9]{2})/i);return(alpha&255)<<24|(parseInt(r,16)&255)<<16|(parseInt(g,16)&255)<<8|parseInt(b,16)&255}const pluginInfoCache={},getPluginInfo=function(plugin){return pluginInfoCache[plugin]!==void 0?{res:pluginInfoCache[plugin]}:plugins.plugins[plugin]?{res:pluginInfoCache[plugin]=plugins.plugins[plugin].manifest}:{res:!1,promise:async function(){try{pluginInfoCache[plugin]=await(await fetch(`${plugin}manifest.json`,{headers:{"cache-control":"public; max-age=30"}})).json()}catch{pluginInfoCache[plugin]=null}return updateMessages(plugin),pluginInfoCache[plugin]}()}},getCodedLink=function(plugin){const obj={borderColor:0,backgroundColor:androidifyColor(resolveSemanticColor(ui.semanticColors.BACKGROUND_SECONDARY)),thumbnailCornerRadius:0,headerColor:androidifyColor(resolveSemanticColor(ui.semanticColors.HEADER_PRIMARY)),headerText:"",acceptLabelBackgroundColor:0,titleText:"",type:null,extendedType:4,participantAvatarUris:[],acceptLabelText:"",noParticipantsText:"",ctaEnabled:!1,plugin},info=getPluginInfo(plugin).res,installing=pluginInstallingCache[plugin];if(info===!1)obj.headerText="...";else if(info===null)obj.headerText="unknown plugin";else{obj.titleText=info.name,obj.noParticipantsText=`
${info.description}`,obj.ctaEnabled=!installing;const has=!!plugins.plugins[plugin];obj.acceptLabelBackgroundColor=androidifyColor(resolveSemanticColor(!has||installing?ui.semanticColors.BUTTON_POSITIVE_BACKGROUND:ui.semanticColors.BUTTON_DANGER_BACKGROUND)),obj.acceptLabelText=installing?"...":has?"Uninstall Plugin":"Install Plugin"}return obj};var _this=void 0;const DCDChatManager=common.ReactNative.NativeModules.DCDChatManager,codedLinksCache={},{MessagesHandlers}=metro.findByProps("MessagesHandlers");function patcher(){const patches=new Array;patches.push(patcher$1.before("updateRows",DCDChatManager,function(args){var _a,_b;const rows=JSON.parse(args[1]);for(const row of rows){const plugins2=new Array,iterate=function(thing){return(Array.isArray(thing)?thing:[thing]).forEach(function(x){if(typeof x.content=="string")for(const url of x.content.match(constants.HTTP_REGEX_MULTI)??[])[_vendetta.constants.PROXY_PREFIX,"https://vendetta.nexpid.xyz/",/^https?:\/\/\w+\.github\.io\//i].some(function(x2){return x2 instanceof RegExp?x2.test(url.toLowerCase()):url.toLowerCase().startsWith(x2.toLowerCase())})&&plugins2.push(url.endsWith("/")?url:`${url}/`);else if(typeof x.content=="object"&&x.content!==null)return iterate(x.content)})};if(row.message){row.message.content&&iterate(row.message.content);for(const[plug,ids]of Object.entries(pluginMessageCache))ids.find(function(x){return x[0]===row.message.id})&&!plugins2.includes(plug)&&(ids.length===1?delete pluginMessageCache[plug]:pluginMessageCache[plug]=ids.filter(function(x){return x[0]!==row.message.id}));plugins2[0]&&(codedLinksCache[row.message.id]={});for(const plugin of plugins2)(_a=pluginMessageCache)[plugin]??(_a[plugin]=[]),pluginMessageCache[plugin].find(function(x){return x[0]===row.message.id})||pluginMessageCache[plugin].push([row.message.id,row.message.channelId]),(_b=row.message).codedLinks??(_b.codedLinks=[]),codedLinksCache[row.message.id][row.message.codedLinks.push(getCodedLink(plugin))-1]=plugin}}args[1]=JSON.stringify(rows)}));const patchHandlers=function(handlers){handlers.__ple_patched||(handlers.__ple_patched=!0,Object.prototype.hasOwnProperty.call(handlers,"handleTapInviteEmbed")&&patches.push(patcher$1.instead("handleTapInviteEmbed",handlers,function(args,orig){var _codedLinksCache_messageId;const[{nativeEvent:{index,messageId}}]=args,plugin=(_codedLinksCache_messageId=codedLinksCache[messageId])===null||_codedLinksCache_messageId===void 0?void 0:_codedLinksCache_messageId[index];if(!plugin)return orig.call(_this,...args);if(plugins.plugins[plugin]){try{plugins.removePlugin(plugin)}catch(e){console.log(e),toasts.showToast("Failed to uninstall plugin!",assets.getAssetIDByName("Small"))}updateMessages(plugin,!1)}else updateMessages(plugin,!0),plugins.installPlugin(plugin).then(function(){return toasts.showToast(`Successfully installed ${plugins.plugins[plugin].manifest.name}.`,assets.getAssetIDByName("Check"))}).catch(function(e){console.log(e),toasts.showToast("Failed to install plugin!",assets.getAssetIDByName("Small"))}).finally(function(){return updateMessages(plugin,!1)})})),patches.push(function(){return handlers.__ple_patched=!1}))},origGetParams=Object.getOwnPropertyDescriptor(MessagesHandlers.prototype,"params").get;return origGetParams&&Object.defineProperty(MessagesHandlers.prototype,"params",{configurable:!0,get(){return this&&patchHandlers(this),origGetParams.call(this)}}),patches.push(function(){return origGetParams&&Object.defineProperty(MessagesHandlers.prototype,"params",{configurable:!0,get:origGetParams})}),function(){return patches.forEach(function(x){return x()})}}let unpatch;const onLoad=function(){return unpatch=patcher()},onUnload=function(){return unpatch?.()};return exports.onLoad=onLoad,exports.onUnload=onUnload,exports})({},vendetta,vendetta.constants,vendetta.metro,vendetta.metro.common,vendetta.patcher,vendetta.plugins,vendetta.ui.assets,vendetta.ui.toasts,vendetta.ui);
