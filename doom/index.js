(function(exports,metro,plugin,common,storage,ui,assets,components,_vendetta,toasts,alerts){"use strict";function SuperAwesomeIcon(param){let{onPress,onLongPress,icon,style,destructive,color}=param;const styles2=common.stylesheet.createThemedStyleSheet({headerStyleIcon:{width:24,height:24,marginRight:10,tintColor:ui.semanticColors.HEADER_PRIMARY},cardStyleIcon:{width:22,height:22,marginLeft:5,tintColor:ui.semanticColors.INTERACTIVE_NORMAL},destructiveIcon:{tintColor:ui.semanticColors.TEXT_DANGER}});return React.createElement(common.ReactNative.TouchableOpacity,{onPress,onLongPress},React.createElement(common.ReactNative.Image,{style:[typeof style=="string"?style==="header"?styles2.headerStyleIcon:styles2.cardStyleIcon:style,destructive&&styles2.destructiveIcon,color&&{tintColor:color}].filter(function(x){return!!x}),source:icon}))}var _findByProps,_findByProps1,_findByProps2,_findByProps3,_findByProps4;const ThemeStore=metro.findByStoreName("ThemeStore");metro.findByProps("triggerHaptic");const colorModule=metro.findByProps("colors","unsafe_rawColors"),colorResolver=colorModule?.internal??colorModule?.meta,TextStyleSheet=metro.findByProps("TextStyleSheet").TextStyleSheet,ActionSheet=((_findByProps=metro.findByProps("ActionSheet"))===null||_findByProps===void 0?void 0:_findByProps.ActionSheet)??metro.find(function(x){var _x_render;return((_x_render=x.render)===null||_x_render===void 0?void 0:_x_render.name)==="ActionSheet"}),LazyActionSheet=metro.findByProps("openLazy","hideActionSheet"),{openLazy,hideActionSheet}=LazyActionSheet,{ActionSheetTitleHeader,ActionSheetCloseButton,ActionSheetContentContainer}=metro.findByProps("ActionSheetTitleHeader","ActionSheetCloseButton","ActionSheetContentContainer");(_findByProps1=metro.findByProps("ActionSheetRow"))===null||_findByProps1===void 0||_findByProps1.ActionSheetRow,metro.findByName("Navigator")??((_findByProps2=metro.findByProps("Navigator"))===null||_findByProps2===void 0||_findByProps2.Navigator),((_findByProps3=metro.findByProps("getRenderCloseButton"))===null||_findByProps3===void 0?void 0:_findByProps3.getRenderCloseButton)??((_findByProps4=metro.findByProps("getHeaderCloseButton"))===null||_findByProps4===void 0||_findByProps4.getHeaderCloseButton),metro.findByProps("popModal","pushModal");function resolveSemanticColor(color){let theme=arguments.length>1&&arguments[1]!==void 0?arguments[1]:ThemeStore.theme;return colorResolver.resolveSemanticColor(theme,color)}function openSheet(sheet,props){try{openLazy(new Promise(function(x){return x({default:sheet})}),"ActionSheet",props)}catch(e){_vendetta.logger.error(e.stack),toasts.showToast("Got error when opening ActionSheet! Please check debug logs",assets.getAssetIDByName("Smal"))}}const{Text:_Text}=components.General;function Text(param){let{variant,lineClamp,color,align,style,onPress,getChildren,children,liveUpdate}=param;const[_,forceUpdate]=common.React.useReducer(function(x){return~x},0);return common.React.useEffect(function(){if(!liveUpdate)return;const nextSecond=new Date().setMilliseconds(1e3);let interval;const timeout=setTimeout(function(){forceUpdate(),interval=setInterval(forceUpdate,1e3)},nextSecond-Date.now());return function(){clearTimeout(timeout),clearInterval(interval)}},[]),common.React.createElement(_Text,{style:[variant?TextStyleSheet[variant]:{},color?{color:resolveSemanticColor(ui.semanticColors[color])}:{},align?{textAlign:align}:{},style??{}],numberOfLines:lineClamp,onPress},getChildren?.()??children)}const WebView=metro.find(function(x){return x?.WebView&&!x.default}).WebView;metro.findByProps("SvgXml"),metro.findByProps("isJoi"),metro.findByProps("useSharedValue"),metro.findByProps("FlashList").FlashList;const RNFileManager=common.ReactNative.NativeModules.DCDFileManager??common.ReactNative.NativeModules.RTNFileManager;common.ReactNative.NativeModules.BundleUpdaterManager,common.ReactNative.NativeModules.MMKVManager,common.ReactNative.NativeModules.DCDSoundManager;const RNFSManager=common.ReactNative.NativeModules.RNFSManager;function usePromise(promise){let deps=arguments.length>1&&arguments[1]!==void 0?arguments[1]:[];const[res,setRes]=common.React.useState({fulfilled:!1}),tracker=common.React.useRef(0);return common.React.useEffect(function(){const id=Date.now();tracker.current=id;const controller=new AbortController;return setRes({fulfilled:!1}),promise(controller.signal).then(function(response){return tracker.current===id&&setRes({fulfilled:!0,success:!0,response})}).catch(function(error){return tracker.current===id&&setRes({fulfilled:!0,success:!1,error})}),function(){return controller.abort()}},deps),res}function managePage(options,navigation){for(var _len=arguments.length,deps=new Array(_len>2?_len-2:0),_key=2;_key<_len;_key++)deps[_key-2]=arguments[_key];navigation||(navigation=common.NavigationNative.useNavigation()),common.React.useEffect(function(){navigation.setOptions(options)},[navigation,...deps])}var webviewCss=`* {
  background-color: transparent !important;
  overflow: hidden !important;
}

#jsbox {
  width: 100vw !important;
  height: 100vh !important;
}
`,webviewHtml=`<!doctype html>
<html>
  <head>
    <script src="URL_JSDOS_JS"><\/script>
    <link rel="stylesheet" href="URL_JSDOS_CSS" />
  </head>
  <body>
    <div id="jsbox" />
  </body>
</html>
<script>
  const cache_wdosboxJs = URL_JSDOS_WDOSBOX_JS;

  const RealXMLHttpRequest = window.XMLHttpRequest;
  window.XMLHttpRequest = class FakeXMLHttpRequest extends RealXMLHttpRequest {
    open(method, url) {
      if (url === "wdosbox.js") return super.open(method, cache_wdosboxJs);
      else if (url === "wdosbox.wasm")
        return super.open(method, URL_JSDOS_WDOSBOX_WASM);
      else return super.open(method, url);
    }
  };

  const RealWorker = window.Worker;
  window.Worker = class FakeWorker extends RealWorker {
    constructor(url) {
      if (url === "wdosbox.js") return super(cache_wdosboxJs);
      else super(url);
    }
  };
<\/script>
<script>
  const element = document.createElement("style");
  element.appendChild(document.createTextNode(REP_WEBVIEW_CSS));
  document.head.appendChild(element);
<\/script>
<script>
  Dos(document.getElementById("jsbox"), {
    style: "none",
    noSideBar: true,
    noFullscreen: true,
    noSocialLinks: true,
  }).run(URL_GAME_LINK);
<\/script>
`;const normalizeFilePath=function(path){return path.startsWith("file://")?path.slice(7):path},getOptions=function(encoding){if(typeof encoding=="string"){if(["utf8","ascii","base64"].includes(encoding))return{encoding};throw new Error(`Invalid encoding type "${String(encoding)}"`)}else return encoding||{encoding:"utf8"}},readFileGeneric=function(filepath,encoding,command){const options=getOptions(encoding);return command(normalizeFilePath(filepath)).then(function(b64){let contents;return options.encoding==="utf8"?contents=Buffer.from(b64,"base64").toString("utf8"):options.encoding==="ascii"?contents=Buffer.from(b64,"base64").toString("ascii"):options.encoding==="base64"&&(contents=b64),contents})},resolveWrite=function(filepath){let write={style:null,path:null};const constants=RNFileManager.getConstants();if(filepath.startsWith(constants.DocumentsDirPath))write={style:"documents",path:filepath.slice(constants.DocumentsDirPath.length+1)};else if(filepath.startsWith(constants.CacheDirPath))write={style:"cache",path:filepath.slice(constants.CacheDirPath.length+1)};else throw new Error(`File path "${String(filepath)}" is unsupported on versions <211.6 (not a caches/documents path, missing RNFS)`);return write},RNFS={unlink(filepath){if(RNFSManager)return RNFSManager.unlink(normalizeFilePath(filepath)).then(function(){});const write=resolveWrite(filepath);return RNFileManager.removeFile(write.style,write.path).then(function(){})},exists(filepath){return RNFSManager?RNFSManager.exists(normalizeFilePath(filepath)):RNFileManager.fileExists(normalizeFilePath(filepath))},readFile(filepath,encoding){if(RNFSManager)return readFileGeneric(filepath,encoding,RNFSManager.readFile);{const options=getOptions(encoding);if(options.encoding==="ascii")throw new Error('Encoding type "ascii" is unsupported on versions <211.6 (missing RNFS)');return RNFileManager.readFile(filepath,options.encoding)}},writeFile(filepath,contents,encoding){const options=getOptions(encoding);if(!RNFSManager){if(options.encoding==="ascii")throw new Error('Encoding type "ascii" is unsupported on versions <211.6 (missing RNFS)');const write=resolveWrite(filepath);return RNFileManager.writeFile(write.style,write.path,contents,options.encoding).then(function(){})}let b64;return options.encoding==="utf8"?b64=Buffer.from(contents,"utf8").toString("base64"):options.encoding==="ascii"?b64=Buffer.from(contents,"ascii").toString("base64"):options.encoding==="base64"&&(b64=contents),RNFSManager.writeFile(normalizeFilePath(filepath),b64,options)},mkdir(filepath){if(!RNFSManager)throw new Error("Function 'mkdir' is unsupported on versions <211.6 (missing RNFS)");return RNFSManager.mkdir(normalizeFilePath(filepath),{}).then(function(){})},MainBundlePath:RNFSManager?.RNFSMainBundlePath,get CachesDirectoryPath(){return RNFSManager?.RNFSCachesDirectoryPath??RNFileManager.getConstants().CacheDirPath},ExternalCachesDirectoryPath:RNFSManager?.RNFSExternalCachesDirectoryPath,get DocumentDirectoryPath(){return RNFSManager?.RNFSDocumentDirectoryPath??RNFileManager.getConstants().DocumentsDirPath},DownloadDirectoryPath:RNFSManager?.RNFSDownloadDirectoryPath,ExternalDirectoryPath:RNFSManager?.RNFSExternalDirectoryPath,ExternalStorageDirectoryPath:RNFSManager?.RNFSExternalStorageDirectoryPath,TemporaryDirectoryPath:RNFSManager?.RNFSTemporaryDirectoryPath,LibraryDirectoryPath:RNFSManager?.RNFSLibraryDirectoryPath,PicturesDirectoryPath:RNFSManager?.RNFSPicturesDirectoryPath,FileProtectionKeys:RNFSManager?.RNFSFileProtectionKeys,RoamingDirectoryPath:RNFSManager?.RNFSRoamingDirectoryPath,hasRNFS:!!RNFSManager},storePrefix="vendetta/DOOM/";function existsFile(fileName){return RNFS.exists(`${RNFS.DocumentDirectoryPath}/${storePrefix+fileName}`)}async function saveFile(fileName,data){let encoding=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"utf8";const dir=(storePrefix+fileName).split("/").slice(0,-1).join("/");return RNFS.hasRNFS&&await RNFS.mkdir(`${RNFS.DocumentDirectoryPath}/${dir}`),await RNFS.writeFile(`${RNFS.DocumentDirectoryPath}/${storePrefix+fileName}`,data,encoding)}async function readFile(fileName){let encoding=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"utf8";const dir=(storePrefix+fileName).split("/").slice(0,-1).join("/");return RNFS.hasRNFS&&await RNFS.mkdir(`${RNFS.DocumentDirectoryPath}/${dir}`),await RNFS.readFile(`${RNFS.DocumentDirectoryPath}/${storePrefix+fileName}`,encoding)}function purgeFiles(){return RNFS.unlink(`${RNFS.DocumentDirectoryPath}/${storePrefix}`)}const manifestVer="v1",getFile=async function(file){let extra=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},content;const oldEtag=!extra.disable&&await existsFile(`${file}.etag`)&&await readFile(`${file}.etag`);if(!extra.disable){const res=await fetch(assetsURL+file,{headers:{"If-None-Match":oldEtag,"Cache-Control":"no-cache"},signal:extra.signal});if(res.ok){const newEtag=res.headers.get("etag");if(newEtag&&newEtag!==oldEtag){saveFile(`${file}.etag`,newEtag);const blob=await res.blob();if(!function(){return new Promise(function(res2){const reader=new FileReader;reader.addEventListener("error",function(){return res2(!1)}),reader.addEventListener("load",function(){const splitter=";base64,",text=reader.result.toString().split(splitter).slice(1).join(splitter);saveFile(file,text,"base64"),content=extra.encoding==="base64"?text:Buffer.from(text,"base64").toString("utf8")}),reader.readAsDataURL(blob)})}())return!1}}}if(!content&&await existsFile(file))content=await readFile(file,extra.encoding??"utf8");else if(!content)return!1;if(extra.parse)try{return extra.parse(content)}catch(e){return console.error("[DOOM] getFile->parser error!"),_vendetta.logger.error(`getFile->parser error!
${e.stack}`),toasts.showToast("Failed to parse file!",assets.getAssetIDByName("Small")),!1}else return content};function getManifest(signal){return getFile(`manifest.${manifestVer}.json`,{signal,parse:function(x){return JSON.parse(x)}})}function getHashes(signal){return getFile("assets/hashes.txt",{signal,parse:function(x){return Object.fromEntries(x.split(`
`).map(function(x2){return x2.split("|")}))}})}const mimes={css:"text/css",js:"text/javascript",wasm:"application/octet-stream",jsdos:"application/zip"};async function getFiles(update,signal){var _manifest_games_find;update("Fetching manifest.json...");const manifest=await getManifest(signal);if(!manifest)return"Failed to get file: manifest.json";update("Fetching hashes.txt...");const hashes=await getHashes(signal);if(!hashes)return"Failed to get file: hashes.text";const root=(_manifest_games_find=manifest.games.find(function(x){return x.id===vstorage.settings.game}))===null||_manifest_games_find===void 0?void 0:_manifest_games_find.root,files=[...Object.entries(manifest.required),root&&["URL_GAME_LINK",root]].filter(function(x){return!!x});update("Fetching assets...");const content={};for(const[key,file]of files){if(signal.aborted)break;const ext=file.split(".").slice(-1)[0],stat=key.endsWith("?u")?{id:key.slice(0,-2),quot:!1}:{id:key,quot:!0};update(`Checking hash for asset:
${file}`);const lastHash=await existsFile(`assets/${file}.hash`)&&await readFile(`assets/${file}.hash`),hash=hashes[file];if(!hash)return`Required file: ${file} doesn't have a hash :3`;hash!==lastHash&&saveFile(`assets/${file}.hash`,hash),update(`Fetching asset:
${file}`);const data=await getFile("assets/"+file,{signal,disable:hash===lastHash,encoding:"base64"});if(!data)return`Failed to fetch asset:
${file}`;if(signal.aborted)break;update("Ok "+file);const url=`data:${mimes[ext]??"text/plain"};base64,${data}`;content[stat.id]=stat.quot?JSON.stringify(url):url}return content}const OhFuck=function(prop){return function(){return common.React.useEffect(function(){toasts.showToast("Uh oh, something broke! Search for fckp in Debug Logs!"),console.warn(`Uh oh (fckp)!!
Missing the redesign component: ${prop}. Please bug @nexpid about this on Discord!`)},[]),null}},OhFuckFunction=function(prop){return function(){return toasts.showToast("Uh oh, something broke! Search for fckp in Debug Logs!"),console.warn(`Uh oh (fckp)!!
Missing the redesign function: ${prop}. Please bug @nexpid about this on Discord!`),null}},findThing=function(){for(var _len=arguments.length,props=new Array(_len),_key=0;_key<_len;_key++)props[_key]=arguments[_key];var _findByProps5;return(_findByProps5=metro.findByProps(...props))===null||_findByProps5===void 0?void 0:_findByProps5[props[0]]},findThingRequired=function(){for(var _len=arguments.length,props=new Array(_len),_key=0;_key<_len;_key++)props[_key]=arguments[_key];return findThing(...props)??OhFuck(props[0])},findFuncRequired=function(){for(var _len=arguments.length,props=new Array(_len),_key=0;_key<_len;_key++)props[_key]=arguments[_key];return findThing(...props)??OhFuckFunction(props[0])},Button=findThingRequired("Button");findThingRequired("RowButton"),findThing("Slider"),findThingRequired("FloatingActionButton"),findThingRequired("TextInput"),findThingRequired("Tabs"),findThingRequired("SegmentedControlPages"),findFuncRequired("useSegmentedControlState");const{FormRow,FormRadioRow}=components.Forms,styles=common.stylesheet.createThemedStyleSheet({wompwomp:{flexDirection:"column",gap:8},destructiveIcon:{tintColor:ui.semanticColors.TEXT_DANGER}}),destructiveText={color:"TEXT_DANGER",variant:"text-md/semibold"};function SettingsActionSheet(param){let{kaboom}=param;const[changes,setChanges]=common.React.useState(vstorage.settings),hasChanges=common.React.useMemo(function(){return["game"].some(function(x){return changes[x]!==vstorage.settings[x]})},[changes]),manifestP=usePromise(function(signal){return getManifest(signal)});if(!manifestP.fulfilled)return common.React.createElement(common.ReactNative.ActivityIndicator,{size:"large",style:{flex:1}});const manifest=manifestP.success&&manifestP.response;return manifest?common.React.createElement(ActionSheet,null,common.React.createElement(ActionSheetContentContainer,null,common.React.createElement(ActionSheetTitleHeader,{title:"Settings",trailing:common.React.createElement(ActionSheetCloseButton,{onPress:function(){return hideActionSheet()}})}),common.React.createElement(FormRow,{label:"Game",subLabel:"What game the DOOM plugin loads",leading:common.React.createElement(FormRow.Icon,{source:assets.getAssetIDByName("HubIcon")})}),manifest.games.map(function(param2){let{title,id}=param2;return common.React.createElement(FormRadioRow,{label:title,onPress:function(){return setChanges({...changes,game:id})},selected:changes.game===id,style:{marginHorizontal:12}})}),common.React.createElement(FormRow,{label:"Suggest new game",leading:common.React.createElement(FormRow.Icon,{source:assets.getAssetIDByName("ic_add_24px")}),style:{marginHorizontal:12},onPress:function(){return common.url.openURL(newGameSuggestionURL())}}),common.React.createElement(FormRow,{label:common.React.createElement(Text,destructiveText,"Delete Files"),leading:common.React.createElement(FormRow.Icon,{style:styles.destructiveIcon,source:assets.getAssetIDByName("ic_trash_24px")}),onPress:function(){return alerts.showConfirmationAlert({title:"Delete DOOM files?",content:"Are you sure you want to delete DOOM files?",confirmText:"Delete",confirmColor:"RED",cancelText:"Cancel",onConfirm:async function(){hideActionSheet(),kaboom(),await purgeFiles(),toasts.showToast("Deleted files",assets.getAssetIDByName("Check"))}})}}),common.React.createElement(Button,{variant:"primary",size:"md",text:"Apply Changes",disabled:!hasChanges,onPress:function(){vstorage.settings=changes,hideActionSheet()},style:{paddingHorizontal:16,paddingVertical:8}}))):common.React.createElement(ActionSheet,null,common.React.createElement(ActionSheetContentContainer,null,common.React.createElement(ActionSheetTitleHeader,{title:"Settings",trailing:common.React.createElement(ActionSheetCloseButton,{onPress:function(){return hideActionSheet()}})}),common.React.createElement(Text,{variant:"text-lg/semibold",color:"TEXT_DANGER",style:styles.wompwomp},"Manifest failed to load.")))}const{View}=components.General,Orientation=metro.findByProps("OrientationType","useOrientation");function App(){storage.useProxy(vstorage);const{width:_width,height:_height}=common.ReactNative.Dimensions.get("window"),navigation=common.NavigationNative.useNavigation(),isLandscape=Orientation.useOrientation()===1,{width}=common.React.useRef({width:isLandscape?_height:_width,height:isLandscape?_width:_height}).current;managePage({headerRight:function(){return common.React.createElement(SuperAwesomeIcon,{onPress:function(){return openSheet(SettingsActionSheet,{kaboom:function(){return navigation.goBack()}})},icon:assets.getAssetIDByName("SettingsIcon"),style:"header"})}});const styles2=common.stylesheet.createThemedStyleSheet({container:{backgroundColor:"#000",flex:1,justifyContent:"center",alignItems:"center"},webview:{backgroundColor:ui.semanticColors.BG_MOD_SUBTLE,overflow:"hidden",borderRadius:2,aspectRatio:1442.8/901.75},webviewPortrait:{height:width,transform:[{rotate:"90deg"}]},webviewLandscape:{height:"100%"},webviewUnder:{position:"absolute",left:0,top:0,width:"100%",height:"100%",justifyContent:"center",alignItems:"center",flexDirection:"column",gap:4,flex:1},androidRipple:{color:ui.semanticColors.ANDROID_RIPPLE,cornerRadius:2147483647}}),[text,setText]=common.React.useState("Updating..."),filePromise=usePromise(function(signal){return getFiles(setText,signal)},[vstorage.settings.game]),files=filePromise.fulfilled&&filePromise.success&&filePromise.response,done=files&&typeof files!="string",html=common.React.useMemo(function(){if(!done)return;let txt=webviewHtml.replace(/REP_WEBVIEW_CSS/g,JSON.stringify(webviewCss));for(const[a,b]of Object.entries(files))txt=txt.replace(new RegExp(a,"g"),b);return txt},[files]);return common.React.createElement(View,{style:styles2.container},common.React.createElement(View,{style:[styles2.webview,isLandscape?styles2.webviewLandscape:styles2.webviewPortrait]},done?common.React.createElement(WebView,{source:{html,baseUrl:"https://localhost"},style:{width:"100%",height:"100%",backgroundColor:"#0000"}}):common.React.createElement(View,{style:styles2.webviewUnder},common.React.createElement(Text,{variant:"text-lg/semibold",color:"WHITE",align:"center"},typeof files=="string"?files:text))))}const UserStore=metro.findByStoreName("UserStore"),assetsURL="https://raw.githubusercontent.com/nexpid/VendettaDOOM/main/";function newGameSuggestionURL(){const user=UserStore.getCurrentUser();return`https://github.com/nexpid/VendettaDOOM/issues/new?${new URLSearchParams({title:"[Game Suggestion]: GAME NAME HERE",labels:"game suggestion",template:"game_suggestion.yml","discord-username":`@${user.username}${user.discriminator!=="0"?`#${user.discriminator}`:""}`})}`}const vstorage=plugin.storage,onLoad=function(){return vstorage.settings??(vstorage.settings={game:"doom1"})},settings=App;return exports.assetsURL=assetsURL,exports.newGameSuggestionURL=newGameSuggestionURL,exports.onLoad=onLoad,exports.settings=settings,exports.vstorage=vstorage,exports})({},vendetta.metro,vendetta.plugin,vendetta.metro.common,vendetta.storage,vendetta.ui,vendetta.ui.assets,vendetta.ui.components,vendetta,vendetta.ui.toasts,vendetta.ui.alerts);
